{% extends 'base.html' %}

{% block content %}
<!-- Header -->
<div style="margin-bottom: 24px;">
    <h1>Analytics & Performance</h1>
    <p class="subtitle">Historische Daten und Performance-Metriken</p>
</div>

<!-- Performance Summary Cards -->
<div class="grid grid-cols-4 mb-6">
    <div class="card">
        <div style="text-align: center;">
            <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Gesamt-Gewinn</p>
            <p style="font-size: 28px; font-weight: 700; color: #22c55e;" id="total-profit">--</p>
            <p style="color: #6b7280; font-size: 12px; margin-top: 4px;" id="profit-period">30 Tage</p>
        </div>
    </div>

    <div class="card">
        <div style="text-align: center;">
            <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Ø Täglich</p>
            <p style="font-size: 28px; font-weight: 700; color: #3b82f6;" id="avg-daily-profit">--</p>
            <p style="color: #6b7280; font-size: 12px; margin-top: 4px;">pro Tag</p>
        </div>
    </div>

    <div class="card">
        <div style="text-align: center;">
            <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Vollzyklen</p>
            <p style="font-size: 28px; font-weight: 700; color: #a855f7;" id="total-cycles">--</p>
            <p style="color: #6b7280; font-size: 12px; margin-top: 4px;">Batterie-Zyklen</p>
        </div>
    </div>

    <div class="card">
        <div style="text-align: center;">
            <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Ø SoC</p>
            <p style="font-size: 28px; font-weight: 700; color: #f97316;" id="avg-soc">--</p>
            <p style="color: #6b7280; font-size: 12px; margin-top: 4px;">durchschnittlich</p>
        </div>
    </div>
</div>

<!-- Info Box wenn keine Daten -->
<div id="no-data-info" class="card" style="margin-bottom: 24px; background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
    <div style="text-align: center; padding: 20px;">
        <svg style="width: 48px; height: 48px; color: #60a5fa; margin: 0 auto 16px;" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
        </svg>
        <h3 style="font-size: 18px; font-weight: 600; color: #93c5fd; margin-bottom: 8px;">Noch keine historischen Daten</h3>
        <p style="color: #94a3b8; font-size: 14px;">Das System sammelt Daten. Analytics werden verfügbar nach mindestens 1 Stunde Betrieb.</p>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-2 mb-6">
    <!-- Daily Profit Chart -->
    <div class="card">
        <h2>
            <svg class="text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
            </svg>
            Täglicher Gewinn
        </h2>
        <div style="height: 300px; position: relative;">
            <canvas id="profitChart"></canvas>
        </div>
    </div>

    <!-- Strategy Distribution -->
    <div class="card">
        <h2>
            <svg class="text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            Strategie-Verteilung
        </h2>
        <div style="height: 300px; position: relative;">
            <canvas id="strategyChart"></canvas>
        </div>
    </div>
</div>

<!-- Optimization History Table -->
<div class="card">
    <h2>
        <svg class="text-blue-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
        </svg>
        Letzte Optimierungen
    </h2>
    <div style="overflow-x: auto;">
        <table style="width: 100%; font-size: 13px;">
            <thead style="background: rgba(17, 24, 39, 0.8);">
                <tr>
                    <th style="padding: 12px; text-align: left; color: #9ca3af; font-weight: 600;">Zeit</th>
                    <th style="padding: 12px; text-align: left; color: #9ca3af; font-weight: 600;">Strategie</th>
                    <th style="padding: 12px; text-align: right; color: #9ca3af; font-weight: 600;">Gewinn (€)</th>
                    <th style="padding: 12px; text-align: center; color: #9ca3af; font-weight: 600;">Status</th>
                    <th style="padding: 12px; text-align: center; color: #9ca3af; font-weight: 600;">Solver</th>
                </tr>
            </thead>
            <tbody id="optimization-table" style="background: rgba(31, 41, 55, 0.3);">
                <tr>
                    <td colspan="5" style="padding: 24px; text-align: center; color: #9ca3af;">Lade Daten...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let profitChart, strategyChart;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Analytics page loaded');
    initializeCharts();
    loadAnalytics();
});

async function loadAnalytics() {
    console.log('Loading analytics data...');
    
    try {
        // Performance Summary
        const summaryResp = await fetch('/api/analytics/summary?days=30');
        if (summaryResp.ok) {
            const contentType = summaryResp.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const summary = await summaryResp.json();
                console.log('Summary:', summary);
                if (summary && !summary.error) {
                    updateSummary(summary);
                } else {
                    console.log('No summary data yet:', summary.error || 'Empty summary');
                    showNoDataMessage();
                }
            } else {
                console.warn('Unexpected content type:', contentType);
                showNoDataMessage();
            }
        } else {
            console.log('Summary request failed:', summaryResp.status);
            showNoDataMessage();
        }

        // Daily Metrics
        const metricsResp = await fetch('/api/analytics/daily?days=30');
        if (metricsResp.ok) {
            const contentType = metricsResp.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const data = await metricsResp.json();
                console.log('Daily metrics:', data);
                if (data.metrics && data.metrics.length > 0) {
                    updateProfitChart(data.metrics);
                    const noDataInfo = document.getElementById('no-data-info');
                    if (noDataInfo) noDataInfo.style.display = 'none';
                } else {
                    console.log('No daily metrics data');
                }
            } else {
                console.warn('Unexpected content type for metrics:', contentType);
            }
        } else {
            console.log('Daily metrics request failed:', metricsResp.status);
        }

        // Optimization History
        const historyResp = await fetch('/api/history/optimization?days=7');
        if (historyResp.ok) {
            const contentType = historyResp.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const data = await historyResp.json();
                console.log('Optimization history:', data);
                if (data.history && data.history.length > 0) {
                    updateOptimizationTable(data.history);
                } else {
                    console.log('No optimization history data');
                }
            } else {
                console.warn('Unexpected content type for history:', contentType);
            }
        } else {
            console.log('Optimization history request failed:', historyResp.status);
        }
    } catch (err) {
        console.error('Error loading analytics:', err);
        showNoDataMessage();
    }
}

function showNoDataMessage() {
    document.getElementById('no-data-info').style.display = 'block';
}

function updateSummary(summary) {
    if (!summary || Object.keys(summary).length === 0) {
        showNoDataMessage();
        return;
    }
    
    document.getElementById('total-profit').textContent = '€' + (summary.total_profit || 0).toFixed(2);
    document.getElementById('avg-daily-profit').textContent = '€' + (summary.avg_daily_profit || 0).toFixed(2);
    document.getElementById('total-cycles').textContent = (summary.total_cycles || 0).toFixed(2);
    document.getElementById('avg-soc').textContent = (summary.avg_soc || 0).toFixed(1) + '%';
    document.getElementById('profit-period').textContent = (summary.period_days || 0) + ' Tage';

    // Update Strategy Chart
    if (summary.strategy_distribution && strategyChart) {
        const labels = Object.keys(summary.strategy_distribution);
        const data = Object.values(summary.strategy_distribution);
        
        if (labels.length > 0) {
            strategyChart.data.labels = labels;
            strategyChart.data.datasets[0].data = data;
            strategyChart.update();
        }
    }
}

function updateProfitChart(metrics) {
    if (!metrics || metrics.length === 0 || !profitChart) return;

    // Reverse für chronologische Reihenfolge
    const sortedMetrics = [...metrics].reverse();

    const labels = sortedMetrics.map(m => m.date);
    const profits = sortedMetrics.map(m => m.total_profit || 0);

    profitChart.data.labels = labels;
    profitChart.data.datasets[0].data = profits;
    profitChart.update();
}

function updateOptimizationTable(history) {
    const tbody = document.getElementById('optimization-table');
    
    if (!history || history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding: 24px; text-align: center; color: #9ca3af;">Noch keine Optimierungen durchgeführt</td></tr>';
        return;
    }

    tbody.innerHTML = history.slice(0, 15).map(opt => {
        const date = new Date(opt.timestamp);
        const statusColor = opt.optimization_status === 'optimal' ? '#22c55e' : '#eab308';
        const statusBg = opt.optimization_status === 'optimal' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(234, 179, 8, 0.2)';
        
        return `
            <tr style="border-bottom: 1px solid rgba(75, 85, 99, 0.3);">
                <td style="padding: 12px; color: #cbd5e1;">${date.toLocaleString('de-DE')}</td>
                <td style="padding: 12px; color: #fff; font-weight: 500;">${opt.strategy_name || '--'}</td>
                <td style="padding: 12px; text-align: right; color: #22c55e; font-weight: 600;">€${(opt.expected_profit || 0).toFixed(2)}</td>
                <td style="padding: 12px; text-align: center;">
                    <span style="padding: 4px 12px; background: ${statusBg}; color: ${statusColor}; border-radius: 12px; font-size: 12px; font-weight: 600;">
                        ${opt.optimization_status || '--'}
                    </span>
                </td>
                <td style="padding: 12px; text-align: center; color: #9ca3af; font-family: monospace; font-size: 12px;">${opt.solver || '--'}</td>
            </tr>
        `;
    }).join('');
}

function initializeCharts() {
    console.log('Initializing charts...');
    
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded!');
        return;
    }
    
    const textColor = 'rgb(229, 231, 235)';
    const gridColor = 'rgba(75, 85, 99, 0.3)';
    
    // Profit Chart
    const profitCtx = document.getElementById('profitChart');
    if (!profitCtx) {
        console.error('profitChart canvas not found');
        return;
    }
    
    try {
        profitChart = new Chart(profitCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Täglicher Gewinn (€)',
                data: [],
                backgroundColor: 'rgba(34, 197, 94, 0.6)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.5,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Gewinn (€)', color: textColor },
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                },
                x: {
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                }
            }
        }
    });

    } catch (err) {
        console.error('Error initializing profit chart:', err);
    }

    // Strategy Chart
    const strategyCtx = document.getElementById('strategyChart');
    if (!strategyCtx) {
        console.error('strategyChart canvas not found');
        return;
    }
    
    try {
        strategyChart = new Chart(strategyCtx.getContext('2d'), {
            type: 'pie',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(234, 179, 8, 0.8)',
                    'rgba(168, 85, 247, 0.8)'
                ],
                borderColor: [
                    'rgb(59, 130, 246)',
                    'rgb(34, 197, 94)',
                    'rgb(234, 179, 8)',
                    'rgb(168, 85, 247)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: textColor,
                        font: { size: 12 },
                        padding: 15
                    }
                }
            }
        }
    });
    } catch (err) {
        console.error('Error initializing strategy chart:', err);
    }
    
    console.log('Charts initialized successfully');
}
</script>
{% endblock %}
