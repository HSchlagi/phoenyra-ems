{% extends 'base.html' %}

{% block content %}
<div style="margin-bottom: 24px;">
    <h1>Monitoring & Telemetrie</h1>
    <p class="subtitle">Live-Überwachung des BESS – SoC, Spannungen, Temperaturen und Statusbits</p>
</div>

<div class="grid grid-cols-4 mb-6" id="monitoring-limits">
    <div class="card">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">State of Health</p>
        <p style="font-size: 26px; font-weight: 700; color: #a855f7;" id="kpi-soh">-- %</p>
        <p style="color: #6b7280; font-size: 12px;">Bewertung laut BMS</p>
    </div>
    <div class="card">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Max. Ladeleistung</p>
        <p style="font-size: 26px; font-weight: 700; color: #34d399;" id="kpi-max-charge">-- kW</p>
        <p style="color: #6b7280; font-size: 12px;">Zulässig laut BMS</p>
    </div>
    <div class="card">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Max. Entladeleistung</p>
        <p style="font-size: 26px; font-weight: 700; color: #f97316;" id="kpi-max-discharge">-- kW</p>
        <p style="color: #6b7280; font-size: 12px;">Zulässig laut BMS</p>
    </div>
    <div class="card">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Isolationswiderstand</p>
        <p style="font-size: 26px; font-weight: 700; color: #facc15;" id="kpi-insulation">-- kOhm</p>
        <p style="color: #6b7280; font-size: 12px;">Prüfung vor dem Einschalten</p>
    </div>
</div>

<!-- KPI Cards -->
<div class="grid grid-cols-5 mb-6" id="monitoring-kpis">
    <div class="card">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">State of Charge</p>
        <p style="font-size: 30px; font-weight: 700; color: #38bdf8;" id="kpi-soc">-- %</p>
        <p style="color: #6b7280; font-size: 12px;" id="kpi-source">Quelle: unbekannt</p>
    </div>
    <div class="card">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Batterieleistung</p>
        <p style="font-size: 30px; font-weight: 700; color: #34d399;" id="kpi-power">-- kW</p>
        <p style="color: #6b7280; font-size: 12px;">Charge (-) / Discharge (+)</p>
    </div>
    <div class="card">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Batteriespannung</p>
        <p style="font-size: 30px; font-weight: 700; color: #f59e0b;" id="kpi-voltage">-- V</p>
        <p style="color: #6b7280; font-size: 12px;">DC-Bus</p>
    </div>
    <div class="card">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Temperatur</p>
        <p style="font-size: 30px; font-weight: 700; color: #f97316;" id="kpi-temperature">-- °C</p>
        <p style="color: #6b7280; font-size: 12px;">Batterie / Zellverbund</p>
    </div>
    <div class="card">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">DSO Status</p>
        <p style="font-size: 22px; font-weight: 700; color: #fca5a5;" id="kpi-dso-trip">—</p>
        <p style="color: #6b7280; font-size: 12px;">Limit: <span id="kpi-dso-limit">—</span></p>
    </div>
</div>

<!-- Zusätzliche KPIs: Einspeisebegrenzung & Netzanschluss - FLEXBOX für horizontale Anordnung -->
<div style="display: flex; flex-direction: row; gap: 16px; margin-bottom: 24px;" id="monitoring-advanced-kpis">
    <div class="card" style="flex: 1 1 0; min-width: 0;">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Einspeisebegrenzung</p>
        <p style="font-size: 26px; font-weight: 700; color: #8b5cf6;" id="kpi-feedin-limit">-- %</p>
        <p style="color: #6b7280; font-size: 12px;" id="kpi-feedin-mode">Modus: --</p>
    </div>
    <div class="card" style="flex: 1 1 0; min-width: 0;">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Netzanschlussgrenze</p>
        <p style="font-size: 26px; font-weight: 700; color: #06b6d4;" id="kpi-grid-max">-- kW</p>
        <p style="color: #6b7280; font-size: 12px;">Max. Leistung</p>
    </div>
    <div class="card" style="flex: 1 1 0; min-width: 0;">
        <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">Netzanschlussauslastung</p>
        <p style="font-size: 26px; font-weight: 700; color: #10b981;" id="kpi-grid-utilization">-- %</p>
        <p style="color: #6b7280; font-size: 12px;">Aktuelle Auslastung</p>
    </div>
</div>

<!-- Charts -->
<div class="grid grid-cols-2 mb-6">
    <div class="card">
        <h2>
            <svg class="text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 3a1 1 0 000 2v10a2 2 0 002 2h10a2 2 0 002-2V5a1 1 0 100-2H3zm12 4H5v8h10V7z"></path>
            </svg>
            SoC Verlauf (letzte 60 min)
        </h2>
        <div style="height: 320px; position: relative;">
            <canvas id="socChart"></canvas>
        </div>
    </div>
    <div class="card">
        <h2>
            <svg class="text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm9 6H7a1 1 0 000 2h6a1 1 0 100-2zm0 4H7a1 1 0 000 2h6a1 1 0 100-2zm0-8H7a1 1 0 000 2h6a1 1 0 100-2z"></path>
            </svg>
            Leistungskanäle (kW)
        </h2>
        <div style="height: 320px; position: relative;">
            <canvas id="powerChart"></canvas>
        </div>
    </div>
</div>

<!-- Powerflow Sankey -->
<div class="card powerflow-card" style="margin-bottom: 24px;">
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
        <h2 style="margin: 0;">
            <svg class="text-cyan-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h3a1 1 0 011 1v2h4V4a1 1 0 011-1h3a1 1 0 011 1v12a1 1 0 01-1 1h-3a1 1 0 01-1-1v-2H8v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm4 1H5v10h2V5zm8 0h-2v10h2V5z"></path>
            </svg>
            Powerflow (letzte 5&nbsp;min)
        </h2>
        <button id="powerflow-toggle" type="button" aria-controls="powerflow-body" aria-expanded="true" style="background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.25); color: #e2e8f0; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer;">
            Einklappen
        </button>
    </div>
    <div id="powerflow-body">
        <div id="powerflow-diagram" style="height: 340px; margin-top: 12px;"></div>
        <div id="powerflow-summary" style="margin-top: 16px; padding: 12px; background: rgba(15, 23, 42, 0.65); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.18); color: #94a3b8; font-size: 13px;">
            Noch keine Powerflow-Daten verfügbar.
        </div>
    </div>
</div>

<!-- Status Information -->
<div class="card">
    <h2>
        <svg class="text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.492-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 10-2 0 1 1 0 002 0zm-1-2a1 1 0 001-1V7a1 1 0 10-2 0v3a1 1 0 001 1z" clip-rule="evenodd"></path>
        </svg>
        Status & Rohdaten
    </h2>
    <div class="grid grid-cols-2 gap-4">
        <div style="padding: 12px; background: rgba(30, 41, 59, 0.6); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
            <p style="color: #94a3b8; font-size: 13px; margin-bottom: 4px;">Modus</p>
            <p style="color: #f1f5f9; font-weight: 600; font-size: 16px;" id="status-mode">--</p>
        </div>
        <div style="padding: 12px; background: rgba(30, 41, 59, 0.6); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
            <p style="color: #94a3b8; font-size: 13px; margin-bottom: 4px;">Statusbits</p>
            <p style="color: #f1f5f9; font-weight: 600; font-size: 16px;" id="status-bits">--</p>
        </div>
        <div style="padding: 12px; background: rgba(30, 41, 59, 0.6); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
            <p style="color: #94a3b8; font-size: 13px; margin-bottom: 4px;">Letztes Update</p>
            <p style="color: #f1f5f9; font-weight: 600; font-size: 16px;" id="status-updated">--</p>
        </div>
        <div style="padding: 12px; background: rgba(30, 41, 59, 0.6); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
            <p style="color: #94a3b8; font-size: 13px; margin-bottom: 4px;">Quelle</p>
            <p style="color: #f1f5f9; font-weight: 600; font-size: 16px;" id="status-source">--</p>
        </div>
        <div style="padding: 12px; background: rgba(30, 41, 59, 0.6); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
            <p style="color: #94a3b8; font-size: 13px; margin-bottom: 4px;">Systemstatus</p>
            <p style="color: #f1f5f9; font-weight: 600; font-size: 16px;" id="status-text">--</p>
            <p style="color: #6b7280; font-size: 12px;" id="status-code">Code: --</p>
        </div>
        <div style="grid-column: span 2; padding: 12px; background: rgba(30, 41, 59, 0.6); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
            <p style="color: #94a3b8; font-size: 13px; margin-bottom: 4px;">Aktive Alarme</p>
            <ul id="status-alarms" style="margin: 0; padding-left: 18px; color: #f87171; font-size: 13px;">
                <li style="color: #6b7280;">Keine aktiven Alarme</li>
            </ul>
        </div>
    </div>
    <div style="margin-top: 16px;">
        <pre id="status-raw" style="background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 12px; padding: 16px; font-size: 12px; color: #94a3b8; max-height: 240px; overflow-y: auto;">{}</pre>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/monitoring.js') }}"></script>
{% endblock %}
