<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Phoenyra EMS{% endblock %}</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    {% if session.user %}
    <nav>
        <div class="nav-container">
            <div style="display: flex; align-items: center; gap: 32px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <img src="{{ url_for('static', filename='logo/Phoenyra_Abstract.png') }}" 
                         alt="Phoenyra Logo" 
                         style="width: 56px; height: 56px; object-fit: contain; filter: brightness(1.3) drop-shadow(0 0 8px rgba(59, 130, 246, 0.4));"
                         onerror="this.style.display='none'">
                    <span class="nav-brand" style="font-size: 20px; font-weight: 800;">Phoenyra EMS</span>
                </div>
                <div class="nav-links">
                    <a href="{{ url_for('web.dashboard') }}" class="nav-link {{ 'active' if request.path == '/' else '' }}">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                        </svg>
                        Dashboard
                    </a>
                    <a href="{{ url_for('web.monitoring') }}" class="nav-link {{ 'active' if request.path == '/monitoring' else '' }}">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm6 3a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1h-2a1 1 0 01-1-1V7zm6-5a1 1 0 00-1 1v14a1 1 0 001 1h2a1 1 0 001-1V3a1 1 0 00-1-1h-2z"></path>
                        </svg>
                        Monitoring
                    </a>
                    <a href="{{ url_for('web.analytics') }}" class="nav-link {{ 'active' if request.path == '/analytics' else '' }}">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                        </svg>
                        Analytics
                    </a>
                    <a href="{{ url_for('web.forecasts') }}" class="nav-link {{ 'active' if request.path == '/forecasts' else '' }}">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"></path>
                        </svg>
                        Prognosen
                    </a>
                    <a href="{{ url_for('web.settings') }}" class="nav-link {{ 'active' if request.path == '/settings' else '' }}">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                        </svg>
                        Einstellungen
                    </a>
                </div>
            </div>
            <div class="nav-user">
                <div class="user-menu-container" style="position: relative; z-index: 999999;">
                    <button class="user-menu-button" onclick="toggleUserMenu(event)" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; position: relative; z-index: 999999;">
                        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px;">
                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                        </svg>
                        {{ session.user.email or session.user.name }}
                        <svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px; margin-left: 4px;">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div id="user-menu-dropdown" class="user-menu-dropdown" style="display: none; position: fixed; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); min-width: 240px; z-index: 999999 !important; overflow: hidden;">
                        <div style="padding: 12px 16px; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                            <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">Angemeldet als</div>
                            <div style="font-size: 14px; color: #212529; font-weight: 600;">{{ session.user.email or session.user.name }}</div>
                        </div>
                        <div style="padding: 8px 0;">
                            <a href="javascript:void(0)" onclick="showUserInfo()" class="user-menu-item" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: #212529; text-decoration: none; font-size: 14px; transition: background 0.2s;">
                                <svg fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px; color: #6c757d;">
                                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                                </svg>
                                Benutzerinfo
                            </a>
                            <a href="javascript:void(0)" onclick="showNotifications()" class="user-menu-item" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: #212529; text-decoration: none; font-size: 14px; transition: background 0.2s;">
                                <svg fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px; color: #6c757d;">
                                    <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                                </svg>
                                Benachrichtigungen
                            </a>
                            <a href="{{ url_for('web.help') }}" class="user-menu-item" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: #212529; text-decoration: none; font-size: 14px; transition: background 0.2s;">
                                <svg fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px; color: #6c757d;">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                </svg>
                                Hilfe & Anleitungen
                            </a>
                        </div>
                        {% if session.user and session.user.role == 'admin' %}
                        <div style="border-top: 1px solid #e9ecef; padding: 8px 0;">
                            <a href="{{ url_for('web.dashboard') }}" class="user-menu-item" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: #3b82f6; text-decoration: none; font-size: 14px; transition: background 0.2s;">
                                <svg fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px;">
                                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                                </svg>
                                Admin-Dashboard
                            </a>
                            <a href="{{ url_for('web.users') }}" class="user-menu-item" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: #3b82f6; text-decoration: none; font-size: 14px; transition: background 0.2s;">
                                <svg fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px;">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                </svg>
                                Benutzer-Verwaltung
                            </a>
                        </div>
                        {% endif %}
                        <div style="border-top: 1px solid #e9ecef; padding: 8px 0;">
                            <a href="{{ url_for('web.logout') }}" class="user-menu-item" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: #dc2626; text-decoration: none; font-size: 14px; transition: background 0.2s;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                Abmelden
                            </a>
                        </div>
                    </div>
                </div>
                <div class="datetime-display" id="datetime-display" style="font-family: 'Courier New', monospace; font-size: 14px; color: #94a3b8;">
                    <div id="date"></div>
                    <div id="time"></div>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}
    
    <main>
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    <footer style="background: #1e293b; border-top: 1px solid #ffd700; padding: 20px 40px; margin-top: 24px;">
      <div style="display: flex; justify-content: space-between; align-items: center; max-width: 100%; color: #94a3b8; font-size: 14px;">
        <span>Phoenyra BESS EMS v2.0</span>
        <span>© 2025 Phoenyra.com by Ing. Heinz Schlagintweit. Alle Rechte vorbehalten.</span>
      </div>
    </footer>
    
    {% block scripts %}{% endblock %}
    <script>
        // Update Datum und Zeit
        function updateDateTime() {
            const now = new Date();
            
            // Datum formatieren: DD.MM.YYYY
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const dateStr = `${day}.${month}.${year}`;
            
            // Zeit formatieren: HH:MM:SS
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeStr = `${hours}:${minutes}:${seconds}`;
            
            // Anzeige aktualisieren
            const dateElem = document.getElementById('date');
            const timeElem = document.getElementById('time');
            if (dateElem) dateElem.textContent = dateStr;
            if (timeElem) timeElem.textContent = timeStr;
        }
        
        // Sofort aktualisieren und dann jede Sekunde
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        // User Menu Toggle
        function toggleUserMenu(event) {
            event.stopPropagation();
            event.preventDefault();
            const dropdown = document.getElementById('user-menu-dropdown');
            const button = document.querySelector('.user-menu-button');
            const isVisible = dropdown.style.display === 'block';
            
            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                // Berechne Position relativ zum Button
                if (button) {
                    const rect = button.getBoundingClientRect();
                    dropdown.style.top = (rect.bottom + 8) + 'px';
                    dropdown.style.right = (window.innerWidth - rect.right) + 'px';
                    dropdown.style.position = 'fixed';
                    dropdown.style.zIndex = '999999';
                }
                dropdown.style.display = 'block';
            }
        }
        
        // Schließe Dropdown beim Klick außerhalb
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-menu-dropdown');
            const button = document.querySelector('.user-menu-button');
            if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // User Info Modal
        function showUserInfo() {
            const modal = document.getElementById('user-info-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('user-menu-dropdown').style.display = 'none';
            }
        }
        
        function closeUserInfo() {
            const modal = document.getElementById('user-info-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Notifications Modal
        function showNotifications() {
            const modal = document.getElementById('notifications-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('user-menu-dropdown').style.display = 'none';
                loadNotifications();
            }
        }
        
        function closeNotifications() {
            const modal = document.getElementById('notifications-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        async function loadNotifications() {
            try {
                const resp = await fetch('/api/notifications');
                if (!resp.ok) {
                    const errorText = await resp.text();
                    console.error('HTTP Error:', resp.status, errorText);
                    throw new Error('HTTP ' + resp.status);
                }
                const data = await resp.json();
                if (data.success !== false) {
                    renderNotifications(data.notifications || []);
                } else {
                    document.getElementById('notifications-list').innerHTML = 
                        `<div style="padding: 16px; text-align: center; color: #ef4444;">Fehler: ${data.error || 'Unbekannter Fehler'}</div>`;
                }
            } catch (err) {
                console.error('Error loading notifications:', err);
                document.getElementById('notifications-list').innerHTML = 
                    '<div style="padding: 16px; text-align: center; color: #ef4444;">Fehler beim Laden der Benachrichtigungen. Bitte Seite neu laden.</div>';
            }
        }
        
        function renderNotifications(notifications) {
            const container = document.getElementById('notifications-list');
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '<div style="padding: 16px; text-align: center; color: #94a3b8;">Keine Benachrichtigungen</div>';
                return;
            }
            
            container.innerHTML = notifications.map(notif => {
                const severityColors = {
                    'critical': '#ef4444',
                    'warning': '#f59e0b',
                    'info': '#3b82f6',
                    'success': '#10b981'
                };
                const severityIcons = {
                    'critical': '⚠️',
                    'warning': '⚠️',
                    'info': 'ℹ️',
                    'success': '✅'
                };
                const color = severityColors[notif.severity] || '#6c757d';
                const icon = severityIcons[notif.severity] || 'ℹ️';
                
                return `
                    <div style="padding: 12px 16px; border-left: 3px solid ${color}; background: rgba(15, 23, 42, 0.5); border-radius: 6px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 20px;">${icon}</span>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                    <strong style="color: #e2e8f0; font-size: 14px;">${notif.title || 'Alarm'}</strong>
                                    <span style="color: #94a3b8; font-size: 11px;">${notif.timestamp || ''}</span>
                                </div>
                                <div style="color: #cbd5e1; font-size: 13px;">${notif.message || ''}</div>
                                ${notif.source ? `<div style="color: #94a3b8; font-size: 11px; margin-top: 4px;">Quelle: ${notif.source}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
    
    <!-- User Info Modal -->
    <div id="user-info-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: #1e293b; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; color: #e2e8f0; font-size: 20px;">Benutzerinformationen</h2>
                <button onclick="closeUserInfo()" style="background: none; border: none; color: #94a3b8; font-size: 28px; cursor: pointer; line-height: 1;">×</button>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Benutzername</label>
                    <div style="padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border-radius: 6px; color: #e2e8f0; font-size: 14px;">{{ session.user.name }}</div>
                </div>
                
                {% if session.user.email %}
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">E-Mail</label>
                    <div style="padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border-radius: 6px; color: #e2e8f0; font-size: 14px;">{{ session.user.email }}</div>
                </div>
                {% endif %}
                
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Rolle</label>
                    <div style="padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border-radius: 6px; color: #e2e8f0; font-size: 14px;">
                        {% if session.user.role == 'admin' %}
                            <span style="padding: 4px 8px; background: #ef444420; color: #ef4444; border-radius: 4px; font-size: 11px; font-weight: 600;">Admin</span>
                        {% elif session.user.role == 'operator' %}
                            <span style="padding: 4px 8px; background: #3b82f620; color: #3b82f6; border-radius: 4px; font-size: 11px; font-weight: 600;">Operator</span>
                        {% else %}
                            <span style="padding: 4px 8px; background: #10b98120; color: #10b981; border-radius: 4px; font-size: 11px; font-weight: 600;">Viewer</span>
                        {% endif %}
                    </div>
                </div>
                
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Berechtigungen</label>
                    <div style="padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border-radius: 6px; color: #cbd5e1; font-size: 13px;">
                        {% if session.user.role == 'admin' %}
                            Vollzugriff auf alle Funktionen des Systems
                        {% elif session.user.role == 'operator' %}
                            Lesen und Schreiben von Konfigurationen
                        {% else %}
                            Nur Lesen (keine Änderungen möglich)
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(71, 85, 105, 0.5);">
                <button onclick="closeUserInfo()" style="width: 100%; padding: 12px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer;">
                    Schließen
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notifications Modal -->
    <div id="notifications-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: #1e293b; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; color: #e2e8f0; font-size: 20px; display: flex; align-items: center; gap: 8px;">
                    <svg fill="currentColor" viewBox="0 0 20 20" style="width: 20px; height: 20px; color: #3b82f6;">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                    </svg>
                    Benachrichtigungen
                </h2>
                <button onclick="closeNotifications()" style="background: none; border: none; color: #94a3b8; font-size: 28px; cursor: pointer; line-height: 1;">×</button>
            </div>
            
            <div id="notifications-list" style="display: flex; flex-direction: column; gap: 8px;">
                <div style="padding: 16px; text-align: center; color: #94a3b8;">Lade Benachrichtigungen...</div>
            </div>
            
            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(71, 85, 105, 0.5);">
                <button onclick="closeNotifications()" style="width: 100%; padding: 12px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer;">
                    Schließen
                </button>
            </div>
        </div>
    </div>
</body>
</html>
