{% extends 'base.html' %}

{% block content %}
<!-- Header -->
<div style="margin-bottom: 24px;">
    <h1>Einstellungen</h1>
    <p class="subtitle">Konfiguration des EMS-Systems</p>
</div>

<!-- Settings Container -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- Strategien -->
    <div class="card">
        <h2>
            <svg class="text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
            </svg>
            Strategie-Steuerung
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                Modus
            </label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button id="btn-auto" onclick="setStrategyMode('auto')" 
                        style="padding: 12px 20px; background: #3b82f6; border: 2px solid #3b82f6; border-radius: 10px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>ü§ñ</span>
                    <span>Automatisch</span>
                </button>
                <button id="btn-manual" onclick="setStrategyMode('manual')" 
                        style="padding: 12px 20px; background: rgba(55, 65, 81, 0.5); border: 2px solid rgba(75, 85, 99, 0.5); border-radius: 10px; color: #cbd5e1; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>‚úã</span>
                    <span>Manuell</span>
                </button>
            </div>
        </div>
        
        <div id="strategy-selector" style="display: none; margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                Strategie w√§hlen
            </label>
            <select id="strategy-select" onchange="selectStrategy()" 
                    style="width: 100%; padding: 14px 16px; background: #0f172a; border: 2px solid #475569; border-radius: 10px; color: #fff; font-size: 15px; font-weight: 500; cursor: pointer;">
                <option value="arbitrage">üí∞ Arbitrage</option>
                <option value="peak_shaving">üìä Peak Shaving</option>
                <option value="self_consumption">‚òÄÔ∏è Self Consumption</option>
                <option value="load_balancing">‚öñÔ∏è Load Balancing</option>
            </select>
        </div>
        
        <div id="current-strategy" 
             style="padding: 16px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #93c5fd; font-size: 14px;">
            <strong>Aktuell:</strong> <span id="active-strategy-name">Lade...</span>
        </div>
    </div>
    
    <!-- BESS Parameter -->
    <div class="card">
        <h2>
            <svg class="text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm-2 4a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path>
            </svg>
            BESS Parameter
        </h2>
        
        <div style="color: #94a3b8; font-size: 14px; background: rgba(100, 116, 139, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            ‚ÑπÔ∏è Aktuelle Konfiguration aus <code style="color: #60a5fa;">config/ems.yaml</code>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Kapazit√§t</p>
                <p style="color: #fff; font-weight: 600;">200 kWh</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Max Ladeleistung</p>
                <p style="color: #fff; font-weight: 600;">100 kW</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Max Entladeleistung</p>
                <p style="color: #fff; font-weight: 600;">100 kW</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">SoC Min/Max</p>
                <p style="color: #fff; font-weight: 600;">10% / 90%</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Lade-Effizienz</p>
                <p style="color: #fff; font-weight: 600;">95%</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Entlade-Effizienz</p>
                <p style="color: #fff; font-weight: 600;">95%</p>
            </div>
        </div>
        
        <p style="margin-top: 16px; font-size: 13px; color: #64748b; text-align: center;">
            Zum √Ñndern: <code style="color: #60a5fa;">app/config/ems.yaml</code> bearbeiten
        </p>
    </div>
</div>

<!-- MQTT/Modbus Configuration Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    
    <!-- MQTT Configuration -->
    <div class="card">
        <h2>
            <svg class="text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
            MQTT Konfiguration
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                <input type="checkbox" id="mqtt-enabled" onchange="toggleMqttConfig()" style="width: 16px; height: 16px;">
                MQTT aktivieren
            </label>
        </div>
        
        <!-- MQTT Config - IMMER SICHTBAR f√ºr Test -->
        <div id="mqtt-config" style="display: block; opacity: 1;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Broker Host</label>
                    <input type="text" id="mqtt-host" value="localhost" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Port</label>
                    <input type="number" id="mqtt-port" value="1883" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Username</label>
                    <input type="text" id="mqtt-username" placeholder="Optional" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Password</label>
                    <input type="password" id="mqtt-password" placeholder="Optional" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Client ID</label>
                <input type="text" id="mqtt-client-id" value="phoenyra_ems" 
                       style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            
            <!-- MQTT Topics Configuration -->
            <div style="margin-bottom: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
                <h3 style="color: #60a5fa; font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    üì° MQTT Topics
                </h3>
                
                <!-- Publish Topics -->
                <div style="margin-bottom: 16px;">
                    <h4 style="color: #93c5fd; font-size: 14px; font-weight: 600; margin-bottom: 8px;">üì§ Publish Topics (EMS ‚Üí MQTT)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Status</label>
                            <input type="text" id="mqtt-topic-publish-status" value="ems/status" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Optimization</label>
                            <input type="text" id="mqtt-topic-publish-optimization" value="ems/optimization" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Alerts</label>
                            <input type="text" id="mqtt-topic-publish-alerts" value="ems/alerts" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">BESS Data</label>
                            <input type="text" id="mqtt-topic-publish-bess" value="bess/data" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                    </div>
                </div>
                
                <!-- Subscribe Topics -->
                <div style="margin-bottom: 16px;">
                    <h4 style="color: #93c5fd; font-size: 14px; font-weight: 600; margin-bottom: 8px;">üì• Subscribe Topics (MQTT ‚Üí EMS)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Commands</label>
                            <input type="text" id="mqtt-topic-subscribe-commands" value="ems/commands" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Setpoints</label>
                            <input type="text" id="mqtt-topic-subscribe-setpoints" value="ems/setpoints" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Strategy Override</label>
                            <input type="text" id="mqtt-topic-subscribe-strategy" value="ems/strategy_override" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Config Updates</label>
                            <input type="text" id="mqtt-topic-subscribe-config" value="ems/config" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 8px 12px; background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
                    <p style="color: #94a3b8; font-size: 12px; margin: 0;">
                        üí° <strong>Hinweis:</strong> Topics werden automatisch mit dem Client ID als Pr√§fix versehen: <code>phoenyra_ems/</code>
                    </p>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button onclick="testMqttConnection()" 
                        style="flex: 1; padding: 10px 16px; background: #10b981; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üîó Test Verbindung
                </button>
                <button onclick="saveMqttConfig()" 
                        style="flex: 1; padding: 10px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üíæ Speichern
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modbus Configuration -->
    <div class="card">
        <h2>
            <svg class="text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
            Modbus Konfiguration
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                <input type="checkbox" id="modbus-enabled" onchange="toggleModbusConfig()" style="width: 16px; height: 16px;">
                Modbus aktivieren
            </label>
        </div>
        
        <div id="modbus-config" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Verbindungstyp</label>
                <select id="modbus-type" onchange="toggleModbusType()" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    <option value="tcp">TCP/IP</option>
                    <option value="rtu">RTU (Serial)</option>
                </select>
            </div>
            
            <div id="modbus-tcp-config" style="opacity: 1; transition: opacity 0.3s ease;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Host</label>
                        <input type="text" id="modbus-host" value="localhost" 
                               style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Port</label>
                        <input type="number" id="modbus-port" value="502" 
                               style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button onclick="testModbusConnection()" 
                        style="flex: 1; padding: 10px 16px; background: #10b981; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üîó Test Verbindung
                </button>
                <button onclick="saveModbusConfig()" 
                        style="flex: 1; padding: 10px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üíæ Speichern
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMode = 'auto';

// Load current settings
async function loadSettings() {
    try {
        const resp = await fetch('/api/strategies');
        const data = await resp.json();
        
        currentMode = data.mode || 'auto';
        document.getElementById('active-strategy-name').textContent = 
            data.current || 'Keine Strategie aktiv';
        
        // Update buttons
        if (currentMode === 'manual') {
            document.getElementById('btn-manual').classList.add('active');
            document.getElementById('btn-auto').classList.remove('active');
            document.getElementById('strategy-selector').style.display = 'block';
            
            // Set select value
            if (data.current) {
                document.getElementById('strategy-select').value = data.current;
            }
        }
    } catch (err) {
        console.error('Error loading settings:', err);
    }
}

// Set strategy mode
async function setStrategyMode(mode) {
    currentMode = mode;
    
    const btnAuto = document.getElementById('btn-auto');
    const btnManual = document.getElementById('btn-manual');
    
    // Update UI
    if (mode === 'auto') {
        btnAuto.style.background = '#3b82f6';
        btnAuto.style.borderColor = '#3b82f6';
        btnAuto.style.color = 'white';
        
        btnManual.style.background = 'rgba(55, 65, 81, 0.5)';
        btnManual.style.borderColor = 'rgba(75, 85, 99, 0.5)';
        btnManual.style.color = '#cbd5e1';
        
        document.getElementById('strategy-selector').style.display = 'none';
        
        // Call API
        try {
            const resp = await fetch('/api/strategy/auto', { method: 'POST' });
            const data = await resp.json();
            
            if (data.success) {
                alert('‚úÖ Automatischer Modus aktiviert!');
                setTimeout(loadSettings, 1000);
            }
        } catch (err) {
            alert('‚ùå Fehler: ' + err.message);
        }
        
    } else {
        btnManual.style.background = '#3b82f6';
        btnManual.style.borderColor = '#3b82f6';
        btnManual.style.color = 'white';
        
        btnAuto.style.background = 'rgba(55, 65, 81, 0.5)';
        btnAuto.style.borderColor = 'rgba(75, 85, 99, 0.5)';
        btnAuto.style.color = '#cbd5e1';
        
        document.getElementById('strategy-selector').style.display = 'block';
    }
}

// Select strategy manually
async function selectStrategy() {
    const strategy = document.getElementById('strategy-select').value;
    
    try {
        const resp = await fetch('/api/strategy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ strategy: strategy })
        });
        
        const data = await resp.json();
        
        if (data.success) {
            alert('‚úÖ Strategie gewechselt zu: ' + strategy);
            document.getElementById('active-strategy-name').textContent = strategy;
        } else {
            alert('‚ùå Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (err) {
        alert('‚ùå Fehler: ' + err.message);
    }
}

// MQTT Configuration Functions
function toggleMqttConfig() {
    console.log('toggleMqttConfig called');
    const enabled = document.getElementById('mqtt-enabled').checked;
    const config = document.getElementById('mqtt-config');
    
    console.log('MQTT enabled:', enabled);
    console.log('Config element found:', !!config);
    
    if (config) {
        if (enabled) {
            console.log('Showing MQTT config');
            config.style.display = 'block';
            config.style.opacity = '1';
        } else {
            console.log('Hiding MQTT config');
            config.style.opacity = '0';
            setTimeout(() => {
                config.style.display = 'none';
            }, 300);
        }
    } else {
        console.error('MQTT config element not found!');
    }
}

function saveMqttConfig() {
    const config = {
        enabled: document.getElementById('mqtt-enabled').checked,
        broker_host: document.getElementById('mqtt-host').value,
        broker_port: parseInt(document.getElementById('mqtt-port').value),
        username: document.getElementById('mqtt-username').value || null,
        password: document.getElementById('mqtt-password').value || null,
        client_id: document.getElementById('mqtt-client-id').value,
        topics: {
            publish: {
                status: document.getElementById('mqtt-topic-publish-status').value,
                optimization: document.getElementById('mqtt-topic-publish-optimization').value,
                alerts: document.getElementById('mqtt-topic-publish-alerts').value,
                bess: document.getElementById('mqtt-topic-publish-bess').value
            },
            subscribe: {
                commands: document.getElementById('mqtt-topic-subscribe-commands').value,
                setpoints: document.getElementById('mqtt-topic-subscribe-setpoints').value,
                strategy: document.getElementById('mqtt-topic-subscribe-strategy').value,
                config: document.getElementById('mqtt-topic-subscribe-config').value
            }
        }
    };
    
    fetch('/api/mqtt/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ MQTT Konfiguration gespeichert!');
        } else {
            alert('‚ùå Fehler beim Speichern: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Fehler beim Speichern der MQTT Konfiguration: ' + error.message);
    });
}

function testMqttConnection() {
    alert('üîó MQTT Verbindungstest (Demo)');
}

// Modbus Configuration Functions
function toggleModbusConfig() {
    const enabled = document.getElementById('modbus-enabled').checked;
    const config = document.getElementById('modbus-config');
    
    if (enabled) {
        config.style.display = 'block';
        config.offsetHeight;
        config.style.opacity = '1';
    } else {
        config.style.opacity = '0';
        setTimeout(() => {
            config.style.display = 'none';
        }, 300);
    }
}

function toggleModbusType() {
    const type = document.getElementById('modbus-type').value;
    const tcpConfig = document.getElementById('modbus-tcp-config');
    const rtuConfig = document.getElementById('modbus-rtu-config');
    
    if (type === 'tcp') {
        if (rtuConfig) rtuConfig.style.display = 'none';
        tcpConfig.style.display = 'block';
        tcpConfig.offsetHeight;
        tcpConfig.style.opacity = '1';
    } else {
        tcpConfig.style.display = 'none';
        if (rtuConfig) {
            rtuConfig.style.display = 'block';
            rtuConfig.offsetHeight;
            rtuConfig.style.opacity = '1';
        }
    }
}

function testModbusConnection() {
    alert('üîó Modbus Verbindungstest (Demo)');
}

function saveModbusConfig() {
    const type = document.getElementById('modbus-type').value;
    let config = {
        enabled: document.getElementById('modbus-enabled').checked,
        connection_type: type,
        timeout: 3.0
    };
    
    if (type === 'tcp') {
        config.host = document.getElementById('modbus-host').value;
        config.port = parseInt(document.getElementById('modbus-port').value);
    }
    
    fetch('/api/modbus/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Modbus Konfiguration gespeichert!');
        } else {
            alert('‚ùå Fehler beim Speichern: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Fehler beim Speichern der Modbus Konfiguration: ' + error.message);
    });
}

// Load current configuration on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Settings page loaded, initializing...');
    
    // Load MQTT config
    fetch('/api/mqtt/config')
    .then(response => response.json())
    .then(data => {
        console.log('MQTT config response:', data);
        if (data.success && data.config) {
            const config = data.config;
            document.getElementById('mqtt-enabled').checked = config.enabled || false;
            document.getElementById('mqtt-host').value = config.broker_host || 'localhost';
            document.getElementById('mqtt-port').value = config.broker_port || 1883;
            document.getElementById('mqtt-username').value = config.username || '';
            document.getElementById('mqtt-password').value = config.password || '';
            document.getElementById('mqtt-client-id').value = config.client_id || 'phoenyra_ems';
            
            // Load topic configurations
            if (config.topics) {
                // Publish topics
                if (config.topics.publish) {
                    document.getElementById('mqtt-topic-publish-status').value = config.topics.publish.status || 'ems/status';
                    document.getElementById('mqtt-topic-publish-optimization').value = config.topics.publish.optimization || 'ems/optimization';
                    document.getElementById('mqtt-topic-publish-alerts').value = config.topics.publish.alerts || 'ems/alerts';
                    document.getElementById('mqtt-topic-publish-bess').value = config.topics.publish.bess || 'bess/data';
                }
                
                // Subscribe topics
                if (config.topics.subscribe) {
                    document.getElementById('mqtt-topic-subscribe-commands').value = config.topics.subscribe.commands || 'ems/commands';
                    document.getElementById('mqtt-topic-subscribe-setpoints').value = config.topics.subscribe.setpoints || 'ems/setpoints';
                    document.getElementById('mqtt-topic-subscribe-strategy').value = config.topics.subscribe.strategy || 'ems/strategy_override';
                    document.getElementById('mqtt-topic-subscribe-config').value = config.topics.subscribe.config || 'ems/config';
                }
            }
        }
    })
    .catch(error => {
        console.error('Error loading MQTT config:', error);
    });
    
    // Load Modbus config
    fetch('/api/modbus/config')
    .then(response => response.json())
    .then(data => {
        console.log('Modbus config response:', data);
        if (data.success && data.config) {
            const config = data.config;
            document.getElementById('modbus-enabled').checked = config.enabled || false;
            document.getElementById('modbus-type').value = config.connection_type || 'tcp';
            document.getElementById('modbus-host').value = config.host || 'localhost';
            document.getElementById('modbus-port').value = config.port || 502;
        }
    })
    .catch(error => {
        console.error('Error loading Modbus config:', error);
    });
    
    // Load strategy settings
    loadSettings();
});
</script>

{% endblock %}
