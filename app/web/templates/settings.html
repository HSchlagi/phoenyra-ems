{% extends 'base.html' %}

{% block content %}
<!-- Header -->
<div style="margin-bottom: 24px;">
    <h1>Einstellungen</h1>
    <p class="subtitle">Konfiguration des EMS-Systems</p>
</div>

<!-- Site Selection (nur bei Multi-Site) -->
{% if multi_site is defined and multi_site %}
<div class="card" style="margin-bottom: 24px;">
    <h2>
        <svg class="text-blue-500" fill="currentColor" viewBox="0 0 20 20" style="width: 20px; height: 20px;">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
        </svg>
        Standort-Auswahl
    </h2>
    <div style="margin-bottom: 16px;">
        <label style="display: block; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
            Konfiguration f√ºr Standort
        </label>
        <select id="site-selector" onchange="changeSite()" 
                style="width: 100%; padding: 14px 16px; background: #0f172a; border: 2px solid #475569; border-radius: 10px; color: #fff; font-size: 15px; font-weight: 500; cursor: pointer;">
            <option value="">Lade Standorte...</option>
        </select>
    </div>
    <div id="site-info" style="padding: 12px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #93c5fd; font-size: 14px; display: none;">
        <strong>Ausgew√§hlt:</strong> <span id="selected-site-name">-</span>
    </div>
</div>
{% endif %}

<!-- Settings Container -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- Strategien -->
    <div class="card">
        <h2>
            <svg class="text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
            </svg>
            Strategie-Steuerung
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                Modus
            </label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button id="btn-auto" onclick="setStrategyMode('auto')" 
                        style="padding: 12px 20px; background: #3b82f6; border: 2px solid #3b82f6; border-radius: 10px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>ü§ñ</span>
                    <span>Automatisch</span>
                </button>
                <button id="btn-manual" onclick="setStrategyMode('manual')" 
                        style="padding: 12px 20px; background: rgba(55, 65, 81, 0.5); border: 2px solid rgba(75, 85, 99, 0.5); border-radius: 10px; color: #cbd5e1; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>‚úã</span>
                    <span>Manuell</span>
                </button>
            </div>
        </div>
        
        <div id="strategy-selector" style="display: none; margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                Strategie w√§hlen
            </label>
            <select id="strategy-select" onchange="selectStrategy()" 
                    style="width: 100%; padding: 14px 16px; background: #0f172a; border: 2px solid #475569; border-radius: 10px; color: #fff; font-size: 15px; font-weight: 500; cursor: pointer;">
                <option value="arbitrage">üí∞ Arbitrage</option>
                <option value="peak_shaving">üìä Peak Shaving</option>
                <option value="self_consumption">‚òÄÔ∏è Self Consumption</option>
                <option value="load_balancing">‚öñÔ∏è Load Balancing</option>
            </select>
        </div>
        
        <div id="current-strategy" 
             style="padding: 16px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #93c5fd; font-size: 14px;">
            <strong>Aktuell:</strong> <span id="active-strategy-name">Lade...</span>
        </div>
        
        <!-- AI Strategy Selection -->
        <div style="margin-top: 24px; padding: 20px; background: rgba(139, 92, 246, 0.1); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 10px;">
            <h3 style="color: #c4b5fd; font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span>ü§ñ</span>
                <span>KI-basierte Strategie-Auswahl</span>
            </h3>
            
            <div style="margin-bottom: 16px;">
                <label style="display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 600; color: #cbd5e1; cursor: pointer;">
                    <input type="checkbox" id="ai-selection-enabled" onchange="toggleAISelection()" 
                           style="width: 20px; height: 20px; cursor: pointer;">
                    <span>AI-Strategie-Auswahl aktivieren</span>
                </label>
            </div>
            
            <div id="ai-status" style="margin-bottom: 16px; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: #94a3b8; font-size: 13px; font-weight: 600;">Status:</span>
                    <span id="ai-status-text" style="color: #fbbf24; font-size: 13px; font-weight: 600;">Lade...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 13px; font-weight: 600;">Trainingsdaten:</span>
                    <span id="ai-training-samples" style="color: #cbd5e1; font-size: 13px;">-</span>
                </div>
            </div>
            
            <div id="ai-actions" style="display: none;">
                <button onclick="trainAIModel()" 
                        style="width: 100%; padding: 10px 16px; background: #8b5cf6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;"
                        onmouseover="this.style.background='#7c3aed'"
                        onmouseout="this.style.background='#8b5cf6'">
                    üéì Modell jetzt trainieren
                </button>
                <button onclick="getAIFeatureImportance()" 
                        style="width: 100%; padding: 10px 16px; background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 8px; color: #c4b5fd; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='rgba(139, 92, 246, 0.4)'"
                        onmouseout="this.style.background='rgba(139, 92, 246, 0.3)'">
                    üìä Feature-Importance anzeigen
                </button>
            </div>
        </div>
    </div>
    
    <!-- BESS Parameter -->
    <div class="card">
        <h2>
            <svg class="text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm-2 4a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path>
            </svg>
            BESS Parameter
        </h2>
        
        {% if multi_site is defined and multi_site %}
        <div id="bess-site-indicator" style="margin-bottom: 16px; padding: 10px 14px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #93c5fd; font-size: 13px; display: none;">
            <span style="display: flex; align-items: center; gap: 6px;">
                <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
                <strong>Standort:</strong> <span id="bess-site-name">Global</span>
            </span>
        </div>
        {% endif %}
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Energiekapazit√§t (kWh)</label>
                <input type="number" id="bess-energy-capacity" step="0.1" min="0"
                       style="width: 100%; padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Max. Ladeleistung (kW)</label>
                <input type="number" id="bess-power-charge-max" step="0.1" min="0"
                       style="width: 100%; padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Max. Entladeleistung (kW)</label>
                <input type="number" id="bess-power-discharge-max" step="0.1" min="0"
                       style="width: 100%; padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">SoC Minimum (%)</label>
                <input type="number" id="bess-soc-min" step="0.1" min="0" max="100"
                       style="width: 100%; padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">SoC Maximum (%)</label>
                <input type="number" id="bess-soc-max" step="0.1" min="0" max="100"
                       style="width: 100%; padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Lade-Effizienz (%)</label>
                <input type="number" id="bess-efficiency-charge" step="0.01" min="0" max="1"
                       style="width: 100%; padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Entlade-Effizienz (%)</label>
                <input type="number" id="bess-efficiency-discharge" step="0.01" min="0" max="1"
                       style="width: 100%; padding: 10px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
        </div>
        
        <button onclick="saveBessConfig()" 
                style="width: 100%; padding: 12px 20px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.background='#2563eb'"
                onmouseout="this.style.background='#3b82f6'">
            üíæ BESS-Parameter speichern
        </button>
        
        <div id="bess-status-message" style="margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 14px; text-align: center; display: none;"></div>
    </div>
</div>

<!-- MQTT/Modbus Configuration Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    
    <!-- MQTT Configuration -->
    <div class="card">
        <h2>
            <svg class="text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
            MQTT Konfiguration
        </h2>
        
        {% if multi_site is defined and multi_site %}
        <div id="mqtt-site-indicator" style="margin-bottom: 16px; padding: 10px 14px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #93c5fd; font-size: 13px; display: none;">
            <span style="display: flex; align-items: center; gap: 6px;">
                <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
                <strong>Standort:</strong> <span id="mqtt-site-name">Global</span>
            </span>
        </div>
        {% endif %}
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                <input type="checkbox" id="mqtt-enabled" onchange="toggleMqttConfig()" style="width: 16px; height: 16px;">
                MQTT aktivieren
            </label>
        </div>
        
        <!-- MQTT Config - IMMER SICHTBAR f√ºr Test -->
        <div id="mqtt-config" style="display: block; opacity: 1;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Broker Host</label>
                    <input type="text" id="mqtt-host" value="localhost" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Port</label>
                    <input type="number" id="mqtt-port" value="1883" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Username</label>
                    <input type="text" id="mqtt-username" placeholder="Optional" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Password</label>
                    <input type="password" id="mqtt-password" placeholder="Optional" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Client ID</label>
                <input type="text" id="mqtt-client-id" value="phoenyra_ems" 
                       style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            
            <!-- MQTT Topics Configuration -->
            <div style="margin-bottom: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
                <h3 style="color: #60a5fa; font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    üì° MQTT Topics
                </h3>
                
                <!-- Publish Topics -->
                <div style="margin-bottom: 16px;">
                    <h4 style="color: #93c5fd; font-size: 14px; font-weight: 600; margin-bottom: 8px;">üì§ Publish Topics (EMS ‚Üí MQTT)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Status</label>
                            <input type="text" id="mqtt-topic-publish-status" value="ems/status" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Optimization</label>
                            <input type="text" id="mqtt-topic-publish-optimization" value="ems/optimization" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Alerts</label>
                            <input type="text" id="mqtt-topic-publish-alerts" value="ems/alerts" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">BESS Data</label>
                            <input type="text" id="mqtt-topic-publish-bess" value="bess/data" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                    </div>
                </div>
                
                <!-- Subscribe Topics -->
                <div style="margin-bottom: 16px;">
                    <h4 style="color: #93c5fd; font-size: 14px; font-weight: 600; margin-bottom: 8px;">üì• Subscribe Topics (MQTT ‚Üí EMS)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Commands</label>
                            <input type="text" id="mqtt-topic-subscribe-commands" value="ems/commands" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Setpoints</label>
                            <input type="text" id="mqtt-topic-subscribe-setpoints" value="ems/setpoints" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Strategy Override</label>
                            <input type="text" id="mqtt-topic-subscribe-strategy" value="ems/strategy_override" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Config Updates</label>
                            <input type="text" id="mqtt-topic-subscribe-config" value="ems/config" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 8px 12px; background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
                    <p style="color: #94a3b8; font-size: 12px; margin: 0;">
                        üí° <strong>Hinweis:</strong> Topics werden automatisch mit dem Client ID als Pr√§fix versehen: <code>phoenyra_ems/</code>
                    </p>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button onclick="testMqttConnection()" 
                        style="flex: 1; padding: 10px 16px; background: #10b981; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üîó Test Verbindung
                </button>
                <button onclick="saveMqttConfig()" 
                        style="flex: 1; padding: 10px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üíæ Speichern
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modbus Configuration -->
    <div class="card">
        <h2>
            <svg class="text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
            Modbus Konfiguration
        </h2>
        
        {% if multi_site is defined and multi_site %}
        <div id="modbus-site-indicator" style="margin-bottom: 16px; padding: 10px 14px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #93c5fd; font-size: 13px; display: none;">
            <span style="display: flex; align-items: center; gap: 6px;">
                <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
                <strong>Standort:</strong> <span id="modbus-site-name">Global</span>
            </span>
        </div>
        {% endif %}
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                <input type="checkbox" id="modbus-enabled" onchange="toggleModbusConfig()" style="width: 16px; height: 16px;">
                Modbus aktivieren
            </label>
        </div>
        
        <div id="modbus-config" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Verbindungstyp</label>
                <select id="modbus-type" onchange="toggleModbusType()" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    <option value="tcp">TCP/IP</option>
                    <option value="rtu">RTU (Serial)</option>
                </select>
            </div>
            
            <div id="modbus-tcp-config" style="opacity: 1; transition: opacity 0.3s ease;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Host</label>
                        <input type="text" id="modbus-host" value="localhost" 
                               style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Port</label>
                        <input type="number" id="modbus-port" value="502" 
                               style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Slave ID</label>
                    <input type="number" id="modbus-slave-id" value="1"
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Retries</label>
                    <input type="number" id="modbus-retries" value="3"
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Poll-Intervall (s)</label>
                    <input type="number" id="modbus-poll-interval" value="2"
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Vordefiniertes Profil</label>
                <select id="modbus-profile-select" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    <option value="">Benutzerdefiniert</option>
                </select>
                <div id="modbus-profile-meta" style="margin-top: 8px; font-size: 12px; color: #94a3b8;"></div>
            </div>
            
            <div style="margin-bottom: 20px; padding: 16px; background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.25); border-radius: 10px;">
                <h3 style="color: #fbbf24; font-size: 15px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    üß≠ Modbus Register Mapping
                </h3>
                <p style="color: #cbd5f5; font-size: 12px; margin-bottom: 12px;">
                    Die Register werden je nach Herstellerprofil vorbelegt. Du kannst Adressen bei Bedarf anpassen ‚Äì Skalierung, Einheit und Funktionscode stammen aus dem ausgew√§hlten Profil.
                </p>
                <div id="modbus-register-container" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button onclick="testModbusConnection()" 
                        style="flex: 1; padding: 10px 16px; background: #10b981; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üîó Test Verbindung
                </button>
                <button onclick="saveModbusConfig()" 
                        style="flex: 1; padding: 10px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üíæ Speichern
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Feed-in Limitation & Grid Connection Configuration -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    
    <!-- Feed-in Limitation -->
    <div class="card">
        <h2>
            <svg class="text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
            Einspeisebegrenzung
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                <input type="checkbox" id="feedin-enabled" onchange="toggleFeedinConfig()" style="width: 16px; height: 16px;">
                Einspeisebegrenzung aktivieren
            </label>
        </div>
        
        <div id="feedin-config" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Modus</label>
                <select id="feedin-mode" onchange="toggleFeedinMode()" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    <option value="off">Aus</option>
                    <option value="fixed">Fest (konstant)</option>
                    <option value="dynamic">Dynamisch (zeitbasiert)</option>
                </select>
            </div>
            
            <div id="feedin-fixed-config" style="display: none;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Begrenzung (%)</label>
                <input type="number" id="feedin-fixed-limit" min="0" max="100" step="0.1" value="70.0"
                       style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            
            <div id="feedin-dynamic-config" style="display: none;">
                <p style="color: #94a3b8; font-size: 12px; margin-bottom: 12px;">
                    Zeitbasierte Regeln (Format: HH:MM-HH:MM)
                </p>
                <div id="feedin-rules-container" style="display: flex; flex-direction: column; gap: 12px;"></div>
                <button onclick="addFeedinRule()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; border: none; border-radius: 6px; color: white; font-size: 13px; cursor: pointer;">
                    + Regel hinzuf√ºgen
                </button>
            </div>
            
            <div style="margin-top: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #cbd5e1;">
                    <input type="checkbox" id="feedin-pv-integration" style="width: 16px; height: 16px;">
                    PV-Prognose-Integration
                </label>
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button onclick="saveFeedinConfig()" 
                        style="flex: 1; padding: 10px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer;">
                    üíæ Speichern
                </button>
            </div>
        </div>
    </div>
    
    <!-- Grid Connection -->
    <div class="card">
        <h2>
            <svg class="text-cyan-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
            Netzanschlussabsicherung
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Max. Netzanschlussleistung (kW)</label>
            <input type="number" id="grid-max-power" min="0" step="0.1" value="30.0"
                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            <p style="color: #64748b; font-size: 11px; margin-top: 4px;">Begrenzt sowohl Einspeisung als auch Bezug</p>
        </div>
        
        <div style="margin-top: 16px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #cbd5e1;">
                <input type="checkbox" id="grid-monitoring-enabled" style="width: 16px; height: 16px;">
                Monitoring aktivieren
            </label>
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button onclick="saveGridConfig()" 
                    style="flex: 1; padding: 10px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer;">
                üíæ Speichern
            </button>
        </div>
    </div>
</div>

<!-- Multi-Site Management (eigener Bereich) -->
<div class="mt-6">
    <div class="card">
        <h2>
            <svg class="text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"></path>
            </svg>
            Multi-Site Management
        </h2>
        
        <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px; background: rgba(15, 23, 42, 0.5); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 12px;">
                <div style="flex: 1;">
                    <label style="font-size: 16px; font-weight: 700; color: #ffffff; cursor: pointer; display: block; margin-bottom: 6px;" for="multisite-enabled">
                        Multi-Site-Modus aktivieren
                    </label>
                    <p style="font-size: 13px; color: #94a3b8; margin: 0;">
                        Mehrere Standorte gleichzeitig verwalten
                    </p>
                </div>
                <!-- Toggle Switch - EXTRA GROSSER, SICHTBARER SLIDER -->
                <div style="position: relative; margin-left: 24px; flex-shrink: 0;">
                    <label for="multisite-enabled" style="position: relative; display: block; width: 72px; height: 40px; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="multisite-enabled" onchange="handleMultiSiteToggle()" style="position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none;">
                        <span id="multisite-toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; border-radius: 40px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 0 0 3px rgba(75, 85, 99, 0.2); border: 3px solid rgba(75, 85, 99, 0.6); display: block; z-index: 1;">
                            <span id="multisite-toggle-knob" style="position: absolute; height: 32px; width: 32px; left: 2px; bottom: 2px; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); border-radius: 50%; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 3px 10px rgba(0,0,0,0.5), 0 0 0 2px rgba(255,255,255,0.1); display: block; z-index: 2;"></span>
                        </span>
                    </label>
                </div>
            </div>
        </div>
        
        <div id="multisite-warning" style="display: none; padding: 14px; background: rgba(59, 130, 246, 0.2); border: 2px solid rgba(59, 130, 246, 0.4); border-radius: 10px; color: #93c5fd; font-size: 14px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">‚ÑπÔ∏è</span>
                <div>
                    <strong style="color: #60a5fa;">Info:</strong> Die Konfiguration wird automatisch gespeichert. Die √Ñnderung wird beim n√§chsten Seiten-Reload aktiv.
                </div>
            </div>
        </div>
        
        <div id="multisite-config" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
            <div style="margin-bottom: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: #60a5fa; font-weight: 600;">Konfigurierte Standorte:</span>
                    <span id="multisite-sites-count" style="color: #93c5fd; font-weight: 600;">0</span>
                </div>
                <div id="multisite-sites-list" style="max-height: 200px; overflow-y: auto;">
                    <!-- Sites werden hier dynamisch geladen -->
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 8px;">
                    ‚ÑπÔ∏è Um Standorte hinzuzuf√ºgen, bearbeiten Sie <code style="color: #60a5fa;">app/config/ems.yaml</code> 
                    oder verwenden Sie die Beispiel-Konfiguration: <code style="color: #60a5fa;">app/config/ems_multi_site_example.yaml</code>
                </p>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button onclick="saveMultiSiteConfig()" 
                        style="flex: 1; padding: 12px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: background 0.2s;">
                    üíæ Speichern
                </button>
                <button onclick="loadMultiSiteStatus()" 
                        style="padding: 12px 16px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #60a5fa; font-weight: 600; font-size: 14px; cursor: pointer; transition: background 0.2s;">
                    üîÑ Aktualisieren
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Grid Tariffs & Other Configurations -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    <!-- Grid Tariffs -->
    <div class="card">
        <h2>
            <svg class="text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"></path>
            </svg>
            Dynamische Netzentgelte
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                <input type="checkbox" id="grid-tariffs-enabled" onchange="toggleGridTariffsConfig()" style="width: 16px; height: 16px;">
                Netzentgelte aktivieren
            </label>
        </div>
        
        <div id="grid-tariffs-config" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Tarifstruktur</label>
                <select id="grid-tariffs-structure" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    <option value="NE3">NE3 ‚Äì Hochspannungsnetz (110 kV)</option>
                    <option value="NE4">NE4 ‚Äì Mittelspannungsnetz (10‚Äì30 kV)</option>
                    <option value="NE5">NE5 ‚Äì Niederspannungs-Verteilnetz (400/230 V)</option>
                    <option value="NE6">NE6 ‚Äì Kundeninstallation / Hausanschluss (400/230 V)</option>
                    <option value="NE7">NE7 ‚Äì Endverbraucherebene (400/230 V)</option>
                    <option value="custom">Benutzerdefiniert</option>
                </select>
            </div>
            
            <div id="grid-tariffs-custom-config" style="display: none; margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Basis-Tarif (EUR/kW)</label>
                <input type="number" id="grid-tariffs-base-tariff" min="0" step="0.01" value="0.15"
                       style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            
            <div style="margin-top: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #cbd5e1;">
                    <input type="checkbox" id="grid-tariffs-time-variable" onchange="toggleGridTariffsTimeVariable()" style="width: 16px; height: 16px;">
                    Zeitvariable Tarife (Hochlastzeitfenster)
                </label>
            </div>
            
            <div id="grid-tariffs-windows-config" style="display: none; margin-top: 16px;">
                <p style="color: #94a3b8; font-size: 12px; margin-bottom: 12px;">
                    Hochlastzeitfenster (Format: HH:MM-HH:MM, Multiplikator)
                </p>
                <div id="grid-tariffs-windows-container" style="display: flex; flex-direction: column; gap: 12px;"></div>
                <button onclick="addGridTariffWindow()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; border: none; border-radius: 6px; color: white; font-size: 13px; cursor: pointer;">
                    + Zeitfenster hinzuf√ºgen
                </button>
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button onclick="saveGridTariffsConfig()" 
                        style="flex: 1; padding: 10px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer;">
                    üíæ Speichern
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMode = 'auto';

const MODBUS_FUNCTION_NAMES = {
    2: 'Discrete Input (02)',
    3: 'Holding Register (03)',
    4: 'Input Register (04)'
};

const MODBUS_REGISTER_LABELS = {
    soc_percent: { label: 'SoC (%)', description: 'System State of Charge', category: 'telemetry' },
    soh_percent: { label: 'SOH (%)', description: 'System State of Health', category: 'telemetry' },
    voltage_v: { label: 'Spannung (V)', description: 'System-Gesamtspannung', category: 'telemetry' },
    current_a: { label: 'Strom (A)', description: 'Systemstrom (positiv = Laden)', category: 'telemetry' },
    temperature_c: { label: 'Temperatur (degC)', description: 'Durchschnittliche Systemtemperatur', category: 'telemetry' },
    max_discharge_power_kw: { label: 'Max. Entladeleistung (kW)', category: 'limit' },
    max_charge_power_kw: { label: 'Max. Ladeleistung (kW)', category: 'limit' },
    max_discharge_current_a: { label: 'Max. Entladestrom (A)', category: 'limit' },
    max_charge_current_a: { label: 'Max. Ladestrom (A)', category: 'limit' },
    insulation_resistance_kohm: { label: 'Isolationswiderstand (kOhm)', category: 'diagnostics' },
    status_code: { label: 'Statuscode', description: 'BMS Systemstatus', category: 'status' },
    pcs_comm_fault: { label: 'PCS <-> BMS Kommunikation', category: 'diagnostics' },
    ems_comm_fault: { label: 'EMS <-> BMS Kommunikation', category: 'diagnostics' }
};

const MODBUS_REGISTER_ORDER = [
    'soc_percent',
    'soh_percent',
    'voltage_v',
    'current_a',
    'temperature_c',
    'max_discharge_power_kw',
    'max_charge_power_kw',
    'max_discharge_current_a',
    'max_charge_current_a',
    'insulation_resistance_kohm',
    'status_code',
    'pcs_comm_fault',
    'ems_comm_fault'
];

let modbusSelectedProfile = '';
let modbusRegisterDefinitions = {};
let modbusProfileSummaries = {};
let modbusProfileDetailsCache = {};
let modbusStatusCodes = {};

function mergeRegisterDefinitions(base, overrides) {
    const result = {};
    const keys = new Set([
        ...Object.keys(base || {}),
        ...Object.keys(overrides || {})
    ]);
    keys.forEach(key => {
        const baseDef = base && base[key] ? { ...base[key] } : {};
        const overrideDef = overrides && overrides[key] ? { ...overrides[key] } : {};
        result[key] = { ...baseDef, ...overrideDef };
    });
    return result;
}

function formatModbusMeta(definition) {
    const fn = MODBUS_FUNCTION_NAMES[definition.function] || `Function ${definition.function || 3}`;
    const scale = definition.scale !== undefined ? definition.scale : 1;
    const offset = definition.offset !== undefined ? definition.offset : 0;
    const unit = definition.unit ? `Einheit ${definition.unit}` : 'Einheit -';
    const category = definition.category ? `Kategorie ${definition.category}` : '';
    return [fn, `Skalierung ${scale}`, `Offset ${offset}`, unit, category].filter(Boolean).join(' | ');
}

function buildModbusProfileOptions(summaries, selected) {
    const select = document.getElementById('modbus-profile-select');
    if (!select) return;
    select.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Benutzerdefiniert';
    select.appendChild(defaultOption);
    Object.entries(summaries || {}).forEach(([key, meta]) => {
        const option = document.createElement('option');
        option.value = key;
        const labelParts = [];
        if (meta.label) labelParts.push(meta.label);
        if (meta.manufacturer) labelParts.push(meta.manufacturer);
        option.textContent = labelParts.length ? labelParts.join(' | ') : key;
        if (key === selected) {
            option.selected = true;
        }
        select.appendChild(option);
    });
    if (!selected) {
        select.value = '';
    }
}

function updateModbusProfileMeta(profile) {
    const metaEl = document.getElementById('modbus-profile-meta');
    if (!metaEl) return;
    if (!profile) {
        metaEl.textContent = 'Kein Profil ausgew√§hlt. Alle Register k√∂nnen manuell gepflegt werden.';
        return;
    }
    const parts = [];
    if (profile.label) parts.push(profile.label);
    if (profile.manufacturer) parts.push(`Hersteller: ${profile.manufacturer}`);
    if (profile.documentation) parts.push(`Dokumentation: ${profile.documentation}`);
    metaEl.textContent = parts.join(' | ');
}

function buildModbusRegisterTable() {
    const container = document.getElementById('modbus-register-container');
    if (!container) return;
    container.innerHTML = '';

    const definitions = modbusRegisterDefinitions || {};
    if (Object.keys(definitions).length === 0) {
        const empty = document.createElement('div');
        empty.style.color = '#94a3b8';
        empty.style.fontSize = '12px';
        empty.textContent = 'Keine Register definiert. W√§hle ein Profil oder trage manuell Werte ein.';
        container.appendChild(empty);
        return;
    }

    const keys = Array.from(new Set([...MODBUS_REGISTER_ORDER, ...Object.keys(definitions)]));
    keys.forEach(key => {
        const definition = definitions[key];
        if (!definition) return;

        const labels = MODBUS_REGISTER_LABELS[key] || { label: key };
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '16px';
        row.style.alignItems = 'flex-start';
        row.style.background = 'rgba(15, 23, 42, 0.45)';
        row.style.border = '1px solid rgba(148, 163, 184, 0.35)';
        row.style.borderRadius = '10px';
        row.style.padding = '12px 14px';
        row.style.backdropFilter = 'blur(4px)';

        const metaCol = document.createElement('div');
        metaCol.style.flex = '1';

        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.style.color = '#e2e8f0';
        title.textContent = labels.label || key;

        const desc = document.createElement('div');
        desc.style.fontSize = '12px';
        desc.style.color = '#94a3b8';
        desc.textContent = definition.description || labels.description || '';

        const meta = document.createElement('div');
        meta.style.fontSize = '11px';
        meta.style.color = '#60a5fa';
        meta.textContent = formatModbusMeta(definition);

        metaCol.appendChild(title);
        if (desc.textContent) {
            metaCol.appendChild(desc);
        }
        metaCol.appendChild(meta);

        const inputCol = document.createElement('div');
        inputCol.style.width = '140px';

        const label = document.createElement('label');
        label.style.display = 'block';
        label.style.fontSize = '11px';
        label.style.fontWeight = '600';
        label.style.color = '#94a3b8';
        label.style.marginBottom = '4px';
        label.textContent = 'Adresse';

        const input = document.createElement('input');
        input.type = 'number';
        input.id = `modbus-register-${key}`;
        input.dataset.registerKey = key;
        input.value = definition.address !== undefined ? definition.address : '';
        input.style.width = '100%';
        input.style.padding = '8px 10px';
        input.style.background = 'rgba(55, 65, 81, 0.5)';
        input.style.border = '1px solid rgba(75, 85, 99, 0.5)';
        input.style.borderRadius = '6px';
        input.style.color = '#ffffff';

        inputCol.appendChild(label);
        inputCol.appendChild(input);

        row.appendChild(metaCol);
        row.appendChild(inputCol);

        container.appendChild(row);
    });
}

async function handleModbusProfileChange() {
    const select = document.getElementById('modbus-profile-select');
    if (!select) return;

    modbusSelectedProfile = select.value;
    let profileDetails = null;

    if (modbusSelectedProfile) {
        if (!modbusProfileDetailsCache[modbusSelectedProfile]) {
            try {
                const resp = await fetch(`/api/modbus/profiles?profile=${encodeURIComponent(modbusSelectedProfile)}`);
                const data = await resp.json();
                if (data.success) {
                    modbusProfileDetailsCache[modbusSelectedProfile] = data.profile;
                } else {
                    alert('‚ùå Profil konnte nicht geladen werden: ' + (data.error || 'Unbekannter Fehler'));
                    modbusProfileDetailsCache[modbusSelectedProfile] = null;
                }
            } catch (err) {
                alert('‚ùå Profil konnte nicht geladen werden: ' + err.message);
                modbusProfileDetailsCache[modbusSelectedProfile] = null;
            }
        }
        profileDetails = modbusProfileDetailsCache[modbusSelectedProfile];
    }

    const baseRegisters = profileDetails && profileDetails.registers ? profileDetails.registers : {};
    modbusStatusCodes = profileDetails && profileDetails.status_codes ? profileDetails.status_codes : {};
    modbusRegisterDefinitions = mergeRegisterDefinitions(baseRegisters, {});
    updateModbusProfileMeta(profileDetails);
    buildModbusRegisterTable();
}

async function loadSettings() {
    try {
        let url = '/api/strategies';
        if (currentSiteId !== null) {
            url += `?site_id=${currentSiteId}`;
        }
        const resp = await fetch(url);
        const data = await resp.json();
        
        currentMode = data.mode || 'auto';
        document.getElementById('active-strategy-name').textContent = 
            data.current || 'Keine Strategie aktiv';
        
        if (currentMode === 'manual') {
            document.getElementById('btn-manual').classList.add('active');
            document.getElementById('btn-auto').classList.remove('active');
            document.getElementById('strategy-selector').style.display = 'block';
            
            if (data.current) {
                document.getElementById('strategy-select').value = data.current;
            }
        }
        
        // Lade AI-Status
        await loadAIStatus();
    } catch (err) {
        console.error('Error loading settings:', err);
    }
}

let isLoadingAIStatus = false; // Flag um Endlosschleife zu verhindern

async function loadAIStatus() {
    if (isLoadingAIStatus) return; // Verhindere parallele Aufrufe
    isLoadingAIStatus = true;
    
    try {
        let url = '/api/ai/status';
        if (currentSiteId !== null) {
            url += `?site_id=${currentSiteId}`;
        }
        const resp = await fetch(url);
        if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();
        
        if (data.enabled !== undefined && !isTogglingAI) {
            const checkbox = document.getElementById('ai-selection-enabled');
            if (checkbox && checkbox.checked !== data.enabled) {
                checkbox.checked = data.enabled;
                // UI-Status aktualisieren ohne API-Call
                updateAISelectionUI(data.enabled);
            }
        }
        
        if (data.is_trained !== undefined) {
            const statusText = document.getElementById('ai-status-text');
            const trainingSamples = document.getElementById('ai-training-samples');
            
            if (statusText) {
                if (data.is_trained) {
                    statusText.textContent = '‚úÖ Trainiert';
                    statusText.style.color = '#10b981';
                } else {
                    statusText.textContent = '‚è≥ Nicht trainiert';
                    statusText.style.color = '#fbbf24';
                }
            }
            
            if (trainingSamples) {
                trainingSamples.textContent = `${data.training_samples || 0} Samples`;
            }
            
            const aiStatus = document.getElementById('ai-status');
            const aiActions = document.getElementById('ai-actions');
            if (aiStatus) aiStatus.style.display = 'block';
            if (aiActions) aiActions.style.display = 'block';
        }
    } catch (err) {
        console.error('Error loading AI status:', err);
    } finally {
        isLoadingAIStatus = false;
    }
}

function updateAISelectionUI(enabled) {
    // Aktualisiere nur die UI, ohne API-Call
    const aiStatus = document.getElementById('ai-status');
    const aiActions = document.getElementById('ai-actions');
    
    if (enabled) {
        if (aiStatus) aiStatus.style.display = 'block';
        if (aiActions) aiActions.style.display = 'block';
    } else {
        if (aiStatus) aiStatus.style.display = 'none';
        if (aiActions) aiActions.style.display = 'none';
    }
}

let isTogglingAI = false; // Flag um Endlosschleife zu verhindern

async function toggleAISelection() {
    if (isTogglingAI) return; // Verhindere parallele Aufrufe
    isTogglingAI = true;
    
    const checkbox = document.getElementById('ai-selection-enabled');
    if (!checkbox) {
        isTogglingAI = false;
        return;
    }
    
    const enabled = checkbox.checked;
    
    // Aktualisiere UI sofort
    updateAISelectionUI(enabled);
    
    try {
        let url = '/api/ai/config';
        const body = { enabled: enabled };
        if (currentSiteId !== null) {
            body.site_id = currentSiteId;
        }
        
        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        
        if (!resp.ok) {
            const errorText = await resp.text();
            let errorMsg = `HTTP ${resp.status}`;
            try {
                const errorJson = JSON.parse(errorText);
                errorMsg = errorJson.error || errorMsg;
            } catch {
                errorMsg = errorText || errorMsg;
            }
            throw new Error(errorMsg);
        }
        
        const contentType = resp.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await resp.text();
            throw new Error(`Ung√ºltige Antwort vom Server: ${text.substring(0, 100)}`);
        }
        
        const data = await resp.json();
        
        if (data.success) {
            // Lade Status neu (ohne Endlosschleife)
            await loadAIStatus();
            console.log('‚úÖ AI-Einstellung gespeichert');
        } else {
            console.error('‚ùå Fehler:', data.error || 'Unbekannter Fehler');
            checkbox.checked = !enabled;
            updateAISelectionUI(!enabled);
        }
    } catch (err) {
        // Unterdr√ºcke NetworkError-Logs, wenn es nur ein Verbindungsproblem ist
        if (err.name === 'TypeError' && err.message.includes('NetworkError')) {
            console.warn('‚ö†Ô∏è Netzwerkfehler beim Speichern der AI-Einstellung. Bitte versuchen Sie es erneut.');
        } else {
            console.error('‚ùå Fehler beim √Ñndern der AI-Einstellung:', err.message || err);
        }
        checkbox.checked = !enabled;
        updateAISelectionUI(!enabled);
    } finally {
        isTogglingAI = false;
    }
}

async function trainAIModel() {
    if (!confirm('M√∂chten Sie das AI-Modell jetzt trainieren? Dies kann einige Minuten dauern.')) {
        return;
    }
    
    try {
        let url = '/api/ai/train';
        const body = {};
        if (currentSiteId !== null) {
            body.site_id = currentSiteId;
        }
        
        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        
        const data = await resp.json();
        
        if (data.success) {
            alert(`‚úÖ Training gestartet!\n\nTrainingsdaten: ${data.training_samples || 0} Samples\nModell wird trainiert...`);
            await loadAIStatus();
        } else {
            alert('‚ùå Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (err) {
        console.error('Error training AI model:', err);
        alert('‚ùå Fehler beim Training des AI-Modells');
    }
}

async function getAIFeatureImportance() {
    try {
        let url = '/api/ai/features';
        if (currentSiteId !== null) {
            url += `?site_id=${currentSiteId}`;
        }
        
        const resp = await fetch(url);
        const data = await resp.json();
        
        if (data.success && data.features) {
            const features = Object.entries(data.features)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            let message = 'üìä Top 10 Feature-Importance:\n\n';
            features.forEach(([name, importance], idx) => {
                message += `${idx + 1}. ${name}: ${(importance * 100).toFixed(2)}%\n`;
            });
            
            alert(message);
        } else {
            alert('‚ùå Feature-Importance nicht verf√ºgbar. Modell muss zuerst trainiert werden.');
        }
    } catch (err) {
        console.error('Error getting feature importance:', err);
        alert('‚ùå Fehler beim Laden der Feature-Importance');
    }
}

async function setStrategyMode(mode) {
    currentMode = mode;
    
    const btnAuto = document.getElementById('btn-auto');
    const btnManual = document.getElementById('btn-manual');
    
    if (mode === 'auto') {
        btnAuto.style.background = '#3b82f6';
        btnAuto.style.borderColor = '#3b82f6';
        btnAuto.style.color = 'white';
        
        btnManual.style.background = 'rgba(55, 65, 81, 0.5)';
        btnManual.style.borderColor = 'rgba(75, 85, 99, 0.5)';
        btnManual.style.color = '#cbd5e1';
        
        document.getElementById('strategy-selector').style.display = 'none';
        
        try {
            const body = {};
            if (currentSiteId !== null) {
                body.site_id = currentSiteId;
            }
            const resp = await fetch('/api/strategy/auto', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await resp.json();
            
            if (data.success) {
                alert('‚úÖ Automatischer Modus aktiviert!');
                setTimeout(loadSettings, 1000);
            }
        } catch (err) {
            alert('‚ùå Fehler: ' + err.message);
        }
        
    } else {
        btnManual.style.background = '#3b82f6';
        btnManual.style.borderColor = '#3b82f6';
        btnManual.style.color = 'white';
        
        btnAuto.style.background = 'rgba(55, 65, 81, 0.5)';
        btnAuto.style.borderColor = 'rgba(75, 85, 99, 0.5)';
        btnAuto.style.color = '#cbd5e1';
        
        document.getElementById('strategy-selector').style.display = 'block';
    }
}

async function selectStrategy() {
    const strategy = document.getElementById('strategy-select').value;
    
    try {
        const body = { strategy: strategy };
        if (currentSiteId !== null) {
            body.site_id = currentSiteId;
        }
        const resp = await fetch('/api/strategy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        
        const data = await resp.json();
        
        if (data.success) {
            alert('‚úÖ Strategie gewechselt zu: ' + strategy);
            document.getElementById('active-strategy-name').textContent = strategy;
        } else {
            alert('‚ùå Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (err) {
        alert('‚ùå Fehler: ' + err.message);
    }
}

function toggleMqttConfig() {
    const enabled = document.getElementById('mqtt-enabled').checked;
    const config = document.getElementById('mqtt-config');
    
    if (config) {
        if (enabled) {
            config.style.display = 'block';
            config.style.opacity = '1';
        } else {
            config.style.opacity = '0';
            setTimeout(() => {
                config.style.display = 'none';
            }, 300);
        }
    }
}

function saveMqttConfig() {
    const config = {
        enabled: document.getElementById('mqtt-enabled').checked,
        broker_host: document.getElementById('mqtt-host').value,
        broker_port: parseInt(document.getElementById('mqtt-port').value, 10),
        username: document.getElementById('mqtt-username').value || null,
        password: document.getElementById('mqtt-password').value || null,
        client_id: document.getElementById('mqtt-client-id').value,
        topics: {
            publish: {
                status: document.getElementById('mqtt-topic-publish-status').value,
                optimization: document.getElementById('mqtt-topic-publish-optimization').value,
                alerts: document.getElementById('mqtt-topic-publish-alerts').value,
                bess: document.getElementById('mqtt-topic-publish-bess').value
            },
            subscribe: {
                commands: document.getElementById('mqtt-topic-subscribe-commands').value,
                setpoints: document.getElementById('mqtt-topic-subscribe-setpoints').value,
                strategy: document.getElementById('mqtt-topic-subscribe-strategy').value,
                config: document.getElementById('mqtt-topic-subscribe-config').value
            }
        }
    };
    
    // F√ºge site_id hinzu, wenn Multi-Site aktiv
    if (currentSiteId !== null) {
        config.site_id = currentSiteId;
    }
    
    fetch('/api/mqtt/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ MQTT Konfiguration gespeichert!');
        } else {
            alert('‚ùå Fehler beim Speichern: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Fehler beim Speichern der MQTT Konfiguration: ' + error.message);
    });
}

function testMqttConnection() {
    alert('üîó MQTT Verbindungstest (Demo)');
}

function toggleModbusConfig() {
    const enabled = document.getElementById('modbus-enabled').checked;
    const config = document.getElementById('modbus-config');
    
    if (enabled) {
        config.style.display = 'block';
        config.offsetHeight;
        config.style.opacity = '1';
    } else {
        config.style.opacity = '0';
        setTimeout(() => {
            config.style.display = 'none';
        }, 300);
    }
}

function toggleModbusType() {
    const type = document.getElementById('modbus-type').value;
    const tcpConfig = document.getElementById('modbus-tcp-config');
    const rtuConfig = document.getElementById('modbus-rtu-config');
    
    if (type === 'tcp') {
        if (rtuConfig) rtuConfig.style.display = 'none';
        tcpConfig.style.display = 'block';
        tcpConfig.offsetHeight;
        tcpConfig.style.opacity = '1';
    } else {
        tcpConfig.style.display = 'none';
        if (rtuConfig) {
            rtuConfig.style.display = 'block';
            rtuConfig.offsetHeight;
            rtuConfig.style.opacity = '1';
        }
    }
}

function collectModbusConfigInput() {
    const type = document.getElementById('modbus-type').value;
    const config = {
        enabled: document.getElementById('modbus-enabled').checked,
        connection_type: type,
        slave_id: parseInt(document.getElementById('modbus-slave-id').value, 10) || 1,
        retries: parseInt(document.getElementById('modbus-retries').value, 10) || 3,
        poll_interval_s: parseFloat(document.getElementById('modbus-poll-interval').value) || 2.0,
        profile: modbusSelectedProfile || null,
        timeout: 3.0
    };

    const statusPrepared = {};
    Object.keys(modbusStatusCodes || {}).forEach(key => {
        statusPrepared[String(key)] = modbusStatusCodes[key];
    });
    if (Object.keys(statusPrepared).length > 0) {
        config.status_codes = statusPrepared;
    }
    
    if (type === 'tcp') {
        config.host = document.getElementById('modbus-host').value || 'localhost';
        config.port = parseInt(document.getElementById('modbus-port').value, 10) || 502;
    }
    
    const registers = {};
    Object.keys(modbusRegisterDefinitions || {}).forEach(key => {
        const input = document.getElementById(`modbus-register-${key}`);
        const definition = { ...modbusRegisterDefinitions[key] };
        if (input && input.value !== '') {
            const val = parseInt(input.value, 10);
            if (!Number.isNaN(val)) {
                definition.address = val;
            } else {
                delete definition.address;
            }
        }
        registers[key] = definition;
        modbusRegisterDefinitions[key] = definition;
    });
    config.registers = registers;
    
    return config;
}

async function testModbusConnection() {
    const config = collectModbusConfigInput();
    try {
        const resp = await fetch('/api/modbus/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (data.success) {
            alert('‚úÖ Modbus Verbindung erfolgreich getestet!');
        } else {
            alert('‚ùå Modbus Test fehlgeschlagen: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (error) {
        alert('‚ùå Modbus Test fehlgeschlagen: ' + error.message);
    }
}

async function saveModbusConfig() {
    const config = collectModbusConfigInput();
    
    // F√ºge site_id hinzu, wenn Multi-Site aktiv
    if (currentSiteId !== null) {
        config.site_id = currentSiteId;
    }
    
    try {
        const resp = await fetch('/api/modbus/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (data.success) {
            alert('‚úÖ Modbus Konfiguration gespeichert!');
        } else {
            alert('‚ùå Fehler beim Speichern: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (error) {
        alert('‚ùå Fehler beim Speichern der Modbus Konfiguration: ' + error.message);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const profileSelect = document.getElementById('modbus-profile-select');
    if (profileSelect) {
        profileSelect.addEventListener('change', () => {
            handleModbusProfileChange();
        });
    }

    let mqttUrl = '/api/mqtt/config';
    if (currentSiteId !== null) {
        mqttUrl += `?site_id=${currentSiteId}`;
    }
    fetch(mqttUrl)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            document.getElementById('mqtt-enabled').checked = config.enabled || false;
            document.getElementById('mqtt-host').value = config.broker_host || 'localhost';
            document.getElementById('mqtt-port').value = config.broker_port || 1883;
            document.getElementById('mqtt-username').value = config.username || '';
            document.getElementById('mqtt-password').value = config.password || '';
            document.getElementById('mqtt-client-id').value = config.client_id || 'phoenyra_ems';
            
            if (config.topics) {
                if (config.topics.publish) {
                    document.getElementById('mqtt-topic-publish-status').value = config.topics.publish.status || 'ems/status';
                    document.getElementById('mqtt-topic-publish-optimization').value = config.topics.publish.optimization || 'ems/optimization';
                    document.getElementById('mqtt-topic-publish-alerts').value = config.topics.publish.alerts || 'ems/alerts';
                    document.getElementById('mqtt-topic-publish-bess').value = config.topics.publish.bess || 'bess/data';
                }
                if (config.topics.subscribe) {
                    document.getElementById('mqtt-topic-subscribe-commands').value = config.topics.subscribe.commands || 'ems/commands';
                    document.getElementById('mqtt-topic-subscribe-setpoints').value = config.topics.subscribe.setpoints || 'ems/setpoints';
                    document.getElementById('mqtt-topic-subscribe-strategy').value = config.topics.subscribe.strategy || 'ems/strategy_override';
                    document.getElementById('mqtt-topic-subscribe-config').value = config.topics.subscribe.config || 'ems/config';
                }
            }
        }
    })
    .catch(error => {
        console.error('Error loading MQTT config:', error);
    });
    
    let modbusUrl = '/api/modbus/config';
    if (currentSiteId !== null) {
        modbusUrl += `?site_id=${currentSiteId}`;
    }
    fetch(modbusUrl)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            modbusProfileSummaries = data.profiles || {};
            const profileDetails = data.profile || null;
            if (config.profile && profileDetails) {
                modbusProfileDetailsCache[config.profile] = profileDetails;
            }
            modbusSelectedProfile = config.profile || '';
            modbusStatusCodes = config.status_codes || {};
            const baseRegisters = profileDetails && profileDetails.registers ? profileDetails.registers : {};
            const userRegisters = config.registers || {};
            modbusRegisterDefinitions = mergeRegisterDefinitions(baseRegisters, userRegisters);
            
            document.getElementById('modbus-enabled').checked = config.enabled || false;
            document.getElementById('modbus-type').value = config.connection_type || 'tcp';
            document.getElementById('modbus-host').value = config.host || 'localhost';
            document.getElementById('modbus-port').value = config.port || 502;
            document.getElementById('modbus-slave-id').value = config.slave_id != null ? config.slave_id : 1;
            document.getElementById('modbus-retries').value = config.retries != null ? config.retries : 3;
            document.getElementById('modbus-poll-interval').value = config.poll_interval_s != null ? config.poll_interval_s : 2;
            
            buildModbusProfileOptions(modbusProfileSummaries, modbusSelectedProfile);
            updateModbusProfileMeta(profileDetails);
            buildModbusRegisterTable();
            
            toggleModbusConfig();
            toggleModbusType();
        }
    })
    .catch(error => {
        console.error('Error loading Modbus config:', error);
    });
    
    loadSettings();
    loadFeedinConfig();
    loadGridConfig();
    loadGridTariffsConfig();
});

// Feed-in Limitation Functions
function toggleFeedinConfig() {
    const enabled = document.getElementById('feedin-enabled').checked;
    const config = document.getElementById('feedin-config');
    if (enabled) {
        config.style.display = 'block';
        config.offsetHeight;
        config.style.opacity = '1';
    } else {
        config.style.opacity = '0';
        setTimeout(() => {
            config.style.display = 'none';
        }, 300);
    }
}

function toggleFeedinMode() {
    const mode = document.getElementById('feedin-mode').value;
    const fixedConfig = document.getElementById('feedin-fixed-config');
    const dynamicConfig = document.getElementById('feedin-dynamic-config');
    
    if (mode === 'fixed') {
        fixedConfig.style.display = 'block';
        dynamicConfig.style.display = 'none';
    } else if (mode === 'dynamic') {
        fixedConfig.style.display = 'none';
        dynamicConfig.style.display = 'block';
    } else {
        fixedConfig.style.display = 'none';
        dynamicConfig.style.display = 'none';
    }
}

function addFeedinRule() {
    const container = document.getElementById('feedin-rules-container');
    const ruleDiv = document.createElement('div');
    ruleDiv.style.display = 'grid';
    ruleDiv.style.gridTemplateColumns = '1fr 1fr auto';
    ruleDiv.style.gap = '8px';
    ruleDiv.style.alignItems = 'center';
    
    const timeInput = document.createElement('input');
    timeInput.type = 'text';
    timeInput.placeholder = '06:00-18:00';
    timeInput.style.padding = '8px 12px';
    timeInput.style.background = 'rgba(55, 65, 81, 0.5)';
    timeInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
    timeInput.style.borderRadius = '6px';
    timeInput.style.color = '#fff';
    timeInput.style.fontSize = '14px';
    
    const limitInput = document.createElement('input');
    limitInput.type = 'number';
    limitInput.min = '0';
    limitInput.max = '100';
    limitInput.step = '0.1';
    limitInput.placeholder = '70.0';
    limitInput.style.padding = '8px 12px';
    limitInput.style.background = 'rgba(55, 65, 81, 0.5)';
    limitInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
    limitInput.style.borderRadius = '6px';
    limitInput.style.color = '#fff';
    limitInput.style.fontSize = '14px';
    
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = '√ó';
    deleteBtn.onclick = () => ruleDiv.remove();
    deleteBtn.style.padding = '8px 12px';
    deleteBtn.style.background = '#ef4444';
    deleteBtn.style.border = 'none';
    deleteBtn.style.borderRadius = '6px';
    deleteBtn.style.color = 'white';
    deleteBtn.style.cursor = 'pointer';
    
    ruleDiv.appendChild(timeInput);
    ruleDiv.appendChild(limitInput);
    ruleDiv.appendChild(deleteBtn);
    container.appendChild(ruleDiv);
}

async function loadFeedinConfig() {
    try {
        const resp = await fetch('/api/config/feedin_limitation');
        const data = await resp.json();
        if (data.success && data.config) {
            const cfg = data.config;
            document.getElementById('feedin-enabled').checked = cfg.enabled || false;
            document.getElementById('feedin-mode').value = cfg.mode || 'off';
            document.getElementById('feedin-fixed-limit').value = cfg.fixed_limit_pct || 70.0;
            document.getElementById('feedin-pv-integration').checked = cfg.pv_forecast_integration || false;
            
            // Load dynamic rules
            const container = document.getElementById('feedin-rules-container');
            container.innerHTML = '';
            if (cfg.dynamic_rules && Array.isArray(cfg.dynamic_rules)) {
                cfg.dynamic_rules.forEach(rule => {
                    const ruleDiv = document.createElement('div');
                    ruleDiv.style.display = 'grid';
                    ruleDiv.style.gridTemplateColumns = '1fr 1fr auto';
                    ruleDiv.style.gap = '8px';
                    ruleDiv.style.alignItems = 'center';
                    
                    const timeInput = document.createElement('input');
                    timeInput.type = 'text';
                    timeInput.value = rule.time || '';
                    timeInput.style.padding = '8px 12px';
                    timeInput.style.background = 'rgba(55, 65, 81, 0.5)';
                    timeInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
                    timeInput.style.borderRadius = '6px';
                    timeInput.style.color = '#fff';
                    timeInput.style.fontSize = '14px';
                    
                    const limitInput = document.createElement('input');
                    limitInput.type = 'number';
                    limitInput.min = '0';
                    limitInput.max = '100';
                    limitInput.step = '0.1';
                    limitInput.value = rule.limit_pct || 70.0;
                    limitInput.style.padding = '8px 12px';
                    limitInput.style.background = 'rgba(55, 65, 81, 0.5)';
                    limitInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
                    limitInput.style.borderRadius = '6px';
                    limitInput.style.color = '#fff';
                    limitInput.style.fontSize = '14px';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '√ó';
                    deleteBtn.onclick = () => ruleDiv.remove();
                    deleteBtn.style.padding = '8px 12px';
                    deleteBtn.style.background = '#ef4444';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.borderRadius = '6px';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.cursor = 'pointer';
                    
                    ruleDiv.appendChild(timeInput);
                    ruleDiv.appendChild(limitInput);
                    ruleDiv.appendChild(deleteBtn);
                    container.appendChild(ruleDiv);
                });
            }
            
            toggleFeedinConfig();
            toggleFeedinMode();
        }
    } catch (err) {
        console.error('Error loading feedin config:', err);
    }
}

// Site Selection (Multi-Site)
let currentSiteId = null;

async function loadSites() {
    const selector = document.getElementById('site-selector');
    if (!selector) return; // Nicht im Multi-Site-Modus
    
    try {
        const resp = await fetch('/api/sites');
        if (!resp.ok) {
            console.error('API error:', resp.status, resp.statusText);
            selector.innerHTML = '<option value="">Fehler beim Laden</option>';
            return;
        }
        
        const data = await resp.json();
        console.log('Sites data:', data); // Debug
        
        // Pr√ºfe ob sites vorhanden sind (auch wenn success nicht gesetzt ist)
        if (data.sites && data.sites.length > 0) {
            selector.innerHTML = '<option value="">Alle Standorte (Global)</option>';
            data.sites.forEach(site => {
                const option = document.createElement('option');
                option.value = site.id;
                option.textContent = `${site.name || `Standort ${site.id}`} (ID: ${site.id})`;
                selector.appendChild(option);
            });
            
            // Setze default site oder ersten Standort
            if (data.default_site_id) {
                selector.value = data.default_site_id;
            } else if (data.sites && data.sites.length > 0) {
                // Wenn kein default, nimm ersten Standort
                selector.value = data.sites[0].id;
            }
            // Trigger change to load configs and update indicators
            changeSite();
        } else {
            selector.innerHTML = '<option value="">Keine Standorte gefunden</option>';
            // Auch bei "Global" die Indikatoren anzeigen
            changeSite();
        }
    } catch (err) {
        console.error('Error loading sites:', err);
        selector.innerHTML = '<option value="">Fehler beim Laden</option>';
    }
}

function changeSite() {
    const selector = document.getElementById('site-selector');
    if (!selector) return;
    
    currentSiteId = selector.value ? parseInt(selector.value) : null;
    
    const siteInfo = document.getElementById('site-info');
    const siteName = document.getElementById('selected-site-name');
    const mqttIndicator = document.getElementById('mqtt-site-indicator');
    const mqttSiteName = document.getElementById('mqtt-site-name');
    const modbusIndicator = document.getElementById('modbus-site-indicator');
    const modbusSiteName = document.getElementById('modbus-site-name');
    
    let displayName = 'Global';
    if (currentSiteId) {
        const selectedOption = selector.options[selector.selectedIndex];
        displayName = selectedOption.textContent;
        siteName.textContent = displayName;
        siteInfo.style.display = 'block';
    } else {
        siteName.textContent = displayName;
        siteInfo.style.display = 'block';
    }
    
    // Update MQTT and Modbus indicators
    if (mqttIndicator && mqttSiteName) {
        mqttSiteName.textContent = displayName;
        mqttIndicator.style.display = 'block';
    }
    if (modbusIndicator && modbusSiteName) {
        modbusSiteName.textContent = displayName;
        modbusIndicator.style.display = 'block';
    }
    
    // Update BESS site indicator
    const bessSiteNameEl = document.getElementById('bess-site-name');
    const bessSiteIndicator = document.getElementById('bess-site-indicator');
    if (bessSiteNameEl) {
        bessSiteNameEl.textContent = displayName;
    }
    if (bessSiteIndicator && currentSiteId) {
        bessSiteIndicator.style.display = 'block';
    } else if (bessSiteIndicator) {
        bessSiteIndicator.style.display = 'none';
    }

    // Lade alle Configs f√ºr ausgew√§hlten Standort neu
    loadSettings();
    loadFeedinConfig();
    loadGridConfig();
    loadGridTariffsConfig();
    loadBessConfig();
    
    // Lade MQTT und Modbus Configs neu
    let mqttUrl = '/api/mqtt/config';
    if (currentSiteId !== null) {
        mqttUrl += `?site_id=${currentSiteId}`;
    }
    fetch(mqttUrl)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            document.getElementById('mqtt-enabled').checked = config.enabled || false;
            document.getElementById('mqtt-host').value = config.broker_host || 'localhost';
            document.getElementById('mqtt-port').value = config.broker_port || 1883;
            document.getElementById('mqtt-username').value = config.username || '';
            document.getElementById('mqtt-password').value = config.password || '';
            document.getElementById('mqtt-client-id').value = config.client_id || 'phoenyra_ems';
            if (config.topics) {
                if (config.topics.publish) {
                    document.getElementById('mqtt-topic-publish-status').value = config.topics.publish.status || 'ems/status';
                    document.getElementById('mqtt-topic-publish-optimization').value = config.topics.publish.optimization || 'ems/optimization';
                    document.getElementById('mqtt-topic-publish-alerts').value = config.topics.publish.alerts || 'ems/alerts';
                    document.getElementById('mqtt-topic-publish-bess').value = config.topics.publish.bess || 'bess/data';
                }
                if (config.topics.subscribe) {
                    document.getElementById('mqtt-topic-subscribe-commands').value = config.topics.subscribe.commands || 'ems/commands';
                    document.getElementById('mqtt-topic-subscribe-setpoints').value = config.topics.subscribe.setpoints || 'ems/setpoints';
                    document.getElementById('mqtt-topic-subscribe-strategy').value = config.topics.subscribe.strategy || 'ems/strategy_override';
                    document.getElementById('mqtt-topic-subscribe-config').value = config.topics.subscribe.config || 'ems/config';
                }
            }
        }
    })
    .catch(error => {
        console.error('Error loading MQTT config:', error);
    });
    
    let modbusUrl = '/api/modbus/config';
    if (currentSiteId !== null) {
        modbusUrl += `?site_id=${currentSiteId}`;
    }
    fetch(modbusUrl)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            modbusProfileSummaries = data.profiles || {};
            const profileDetails = data.profile || null;
            if (config.profile && profileDetails) {
                modbusProfileDetailsCache[config.profile] = profileDetails;
            }
            modbusSelectedProfile = config.profile || '';
            modbusStatusCodes = config.status_codes || {};
            const baseRegisters = profileDetails && profileDetails.registers ? profileDetails.registers : {};
            const userRegisters = config.registers || {};
            modbusRegisterDefinitions = mergeRegisterDefinitions(baseRegisters, userRegisters);
            
            // Update UI
            document.getElementById('modbus-enabled').checked = config.enabled || false;
            document.getElementById('modbus-type').value = config.connection_type || 'tcp';
            document.getElementById('modbus-host').value = config.host || 'localhost';
            document.getElementById('modbus-port').value = config.port || 502;
            document.getElementById('modbus-slave-id').value = config.slave_id || 1;
            document.getElementById('modbus-retries').value = config.retries || 3;
            document.getElementById('modbus-poll-interval').value = config.poll_interval_s || 2.0;
            
            if (config.profile) {
                document.getElementById('modbus-profile-select').value = config.profile;
            }
            
            toggleModbusConfig();
            toggleModbusType();
            buildModbusRegisterTable();
        }
    })
    .catch(error => {
        console.error('Error loading Modbus config:', error);
    });
}

async function saveFeedinConfig() {
    const config = {
        enabled: document.getElementById('feedin-enabled').checked,
        mode: document.getElementById('feedin-mode').value,
        fixed_limit_pct: parseFloat(document.getElementById('feedin-fixed-limit').value) || 70.0,
        pv_forecast_integration: document.getElementById('feedin-pv-integration').checked,
        dynamic_rules: []
    };
    
    if (config.mode === 'dynamic') {
        const container = document.getElementById('feedin-rules-container');
        const ruleDivs = container.querySelectorAll('div');
        ruleDivs.forEach(div => {
            const inputs = div.querySelectorAll('input');
            if (inputs.length >= 2) {
                const time = inputs[0].value.trim();
                const limit = parseFloat(inputs[1].value);
                if (time && !isNaN(limit)) {
                    config.dynamic_rules.push({
                        time: time,
                        limit_pct: limit
                    });
                }
            }
        });
    }
    
    // F√ºge site_id hinzu, wenn Multi-Site aktiv
    if (currentSiteId !== null) {
        config.site_id = currentSiteId;
    }
    
    try {
        const resp = await fetch('/api/config/feedin_limitation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (data.success) {
            alert('‚úÖ Einspeisebegrenzung gespeichert!');
        } else {
            alert('‚ùå Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (err) {
        alert('‚ùå Fehler beim Speichern: ' + err.message);
    }
}

async function loadGridConfig() {
    try {
        let url = '/api/config/grid_connection';
        if (currentSiteId !== null) {
            url += `?site_id=${currentSiteId}`;
        }
        const resp = await fetch(url);
        const data = await resp.json();
        if (data.success && data.config) {
            const cfg = data.config;
            document.getElementById('grid-max-power').value = cfg.max_power_kw || 30.0;
            document.getElementById('grid-monitoring-enabled').checked = cfg.monitoring?.enabled || false;
        }
    } catch (err) {
        console.error('Error loading grid config:', err);
    }
}

async function saveGridConfig() {
    const config = {
        max_power_kw: parseFloat(document.getElementById('grid-max-power').value) || 30.0,
        monitoring: {
            enabled: document.getElementById('grid-monitoring-enabled').checked
        }
    };
    
    // F√ºge site_id hinzu, wenn Multi-Site aktiv
    if (currentSiteId !== null) {
        config.site_id = currentSiteId;
    }
    
    try {
        const resp = await fetch('/api/config/grid_connection', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (data.success) {
            alert('‚úÖ Netzanschlusskonfiguration gespeichert!');
        } else {
            alert('‚ùå Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (err) {
        alert('‚ùå Fehler beim Speichern: ' + err.message);
    }
}

// BESS Configuration Functions
async function loadBessConfig() {
    try {
        let url = '/api/config/bess';
        if (currentSiteId !== null) {
            url += `?site_id=${currentSiteId}`;
        }
        const resp = await fetch(url);
        const data = await resp.json();
        if (data.success && data.config) {
            const cfg = data.config;
            document.getElementById('bess-energy-capacity').value = cfg.energy_capacity_kwh || 200.0;
            document.getElementById('bess-power-charge-max').value = cfg.power_charge_max_kw || 100.0;
            document.getElementById('bess-power-discharge-max').value = cfg.power_discharge_max_kw || 100.0;
            document.getElementById('bess-soc-min').value = cfg.soc_min_percent || 10.0;
            document.getElementById('bess-soc-max').value = cfg.soc_max_percent || 90.0;
            document.getElementById('bess-efficiency-charge').value = (cfg.efficiency_charge || 0.95) * 100;
            document.getElementById('bess-efficiency-discharge').value = (cfg.efficiency_discharge || 0.95) * 100;
        }
    } catch (err) {
        console.error('Error loading BESS config:', err);
    }
}

async function saveBessConfig() {
    const config = {
        energy_capacity_kwh: parseFloat(document.getElementById('bess-energy-capacity').value) || 200.0,
        power_charge_max_kw: parseFloat(document.getElementById('bess-power-charge-max').value) || 100.0,
        power_discharge_max_kw: parseFloat(document.getElementById('bess-power-discharge-max').value) || 100.0,
        soc_min_percent: parseFloat(document.getElementById('bess-soc-min').value) || 10.0,
        soc_max_percent: parseFloat(document.getElementById('bess-soc-max').value) || 90.0,
        efficiency_charge: parseFloat(document.getElementById('bess-efficiency-charge').value) / 100 || 0.95,
        efficiency_discharge: parseFloat(document.getElementById('bess-efficiency-discharge').value) / 100 || 0.95
    };
    
    // F√ºge site_id hinzu, wenn Multi-Site aktiv
    if (currentSiteId !== null) {
        config.site_id = currentSiteId;
    }
    
    const statusMsg = document.getElementById('bess-status-message');
    statusMsg.style.display = 'block';
    statusMsg.style.background = 'rgba(59, 130, 246, 0.1)';
    statusMsg.style.color = '#93c5fd';
    statusMsg.textContent = 'Speichere BESS-Parameter...';
    
    try {
        const resp = await fetch('/api/config/bess', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (data.success) {
            statusMsg.style.background = 'rgba(16, 185, 129, 0.1)';
            statusMsg.style.color = '#6ee7b7';
            statusMsg.textContent = '‚úÖ BESS-Parameter erfolgreich gespeichert!';
            setTimeout(() => {
                statusMsg.style.display = 'none';
            }, 3000);
        } else {
            statusMsg.style.background = 'rgba(239, 68, 68, 0.1)';
            statusMsg.style.color = '#fca5a5';
            statusMsg.textContent = '‚ùå Fehler: ' + (data.error || 'Unbekannter Fehler');
        }
    } catch (err) {
        statusMsg.style.background = 'rgba(239, 68, 68, 0.1)';
        statusMsg.style.color = '#fca5a5';
        statusMsg.textContent = '‚ùå Fehler beim Speichern: ' + err.message;
    }
}

// Grid Tariffs Functions
function toggleGridTariffsConfig() {
    const enabled = document.getElementById('grid-tariffs-enabled').checked;
    const config = document.getElementById('grid-tariffs-config');
    if (enabled) {
        config.style.display = 'block';
        config.offsetHeight;
        config.style.opacity = '1';
    } else {
        config.style.opacity = '0';
        setTimeout(() => {
            config.style.display = 'none';
        }, 300);
    }
}

function toggleGridTariffsTimeVariable() {
    const enabled = document.getElementById('grid-tariffs-time-variable').checked;
    const windowsConfig = document.getElementById('grid-tariffs-windows-config');
    if (enabled) {
        windowsConfig.style.display = 'block';
    } else {
        windowsConfig.style.display = 'none';
    }
}

document.getElementById('grid-tariffs-structure')?.addEventListener('change', function() {
    const structure = this.value;
    const customConfig = document.getElementById('grid-tariffs-custom-config');
    if (structure === 'custom') {
        customConfig.style.display = 'block';
    } else {
        customConfig.style.display = 'none';
    }
});

function addGridTariffWindow() {
    const container = document.getElementById('grid-tariffs-windows-container');
    const windowDiv = document.createElement('div');
    windowDiv.style.display = 'grid';
    windowDiv.style.gridTemplateColumns = '1fr 1fr 1fr auto';
    windowDiv.style.gap = '8px';
    windowDiv.style.alignItems = 'center';
    
    const startInput = document.createElement('input');
    startInput.type = 'text';
    startInput.placeholder = '17:00';
    startInput.style.padding = '8px 12px';
    startInput.style.background = 'rgba(55, 65, 81, 0.5)';
    startInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
    startInput.style.borderRadius = '6px';
    startInput.style.color = '#fff';
    startInput.style.fontSize = '14px';
    
    const endInput = document.createElement('input');
    endInput.type = 'text';
    endInput.placeholder = '20:00';
    endInput.style.padding = '8px 12px';
    endInput.style.background = 'rgba(55, 65, 81, 0.5)';
    endInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
    endInput.style.borderRadius = '6px';
    endInput.style.color = '#fff';
    endInput.style.fontSize = '14px';
    
    const multiplierInput = document.createElement('input');
    multiplierInput.type = 'number';
    multiplierInput.min = '0.1';
    multiplierInput.max = '10';
    multiplierInput.step = '0.1';
    multiplierInput.placeholder = '1.5';
    multiplierInput.value = '1.5';
    multiplierInput.style.padding = '8px 12px';
    multiplierInput.style.background = 'rgba(55, 65, 81, 0.5)';
    multiplierInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
    multiplierInput.style.borderRadius = '6px';
    multiplierInput.style.color = '#fff';
    multiplierInput.style.fontSize = '14px';
    
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = '√ó';
    deleteBtn.onclick = () => windowDiv.remove();
    deleteBtn.style.padding = '8px 12px';
    deleteBtn.style.background = '#ef4444';
    deleteBtn.style.border = 'none';
    deleteBtn.style.borderRadius = '6px';
    deleteBtn.style.color = 'white';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.fontSize = '18px';
    deleteBtn.style.fontWeight = 'bold';
    
    windowDiv.appendChild(startInput);
    windowDiv.appendChild(endInput);
    windowDiv.appendChild(multiplierInput);
    windowDiv.appendChild(deleteBtn);
    container.appendChild(windowDiv);
}

async function loadGridTariffsConfig() {
    try {
        let url = '/api/config/grid_tariffs';
        if (currentSiteId !== null) {
            url += `?site_id=${currentSiteId}`;
        }
        const resp = await fetch(url);
        const data = await resp.json();
        if (data.success && data.config) {
            const cfg = data.config;
            document.getElementById('grid-tariffs-enabled').checked = cfg.enabled || false;
            document.getElementById('grid-tariffs-structure').value = cfg.tariff_structure || 'NE7';
            document.getElementById('grid-tariffs-base-tariff').value = cfg.base_tariff_eur_per_kw || 0.15;
            document.getElementById('grid-tariffs-time-variable').checked = cfg.time_variable || false;
            
            // Toggle config visibility
            toggleGridTariffsConfig();
            toggleGridTariffsTimeVariable();
            
            // Trigger structure change to show/hide custom config
            const structureSelect = document.getElementById('grid-tariffs-structure');
            if (structureSelect) {
                const event = new Event('change');
                structureSelect.dispatchEvent(event);
            }
            
            // Load windows
            const container = document.getElementById('grid-tariffs-windows-container');
            container.innerHTML = '';
            if (cfg.high_load_windows && Array.isArray(cfg.high_load_windows)) {
                cfg.high_load_windows.forEach(window => {
                    const windowDiv = document.createElement('div');
                    windowDiv.style.display = 'grid';
                    windowDiv.style.gridTemplateColumns = '1fr 1fr 1fr auto';
                    windowDiv.style.gap = '8px';
                    windowDiv.style.alignItems = 'center';
                    
                    const startInput = document.createElement('input');
                    startInput.type = 'text';
                    startInput.value = window.start || '';
                    startInput.style.padding = '8px 12px';
                    startInput.style.background = 'rgba(55, 65, 81, 0.5)';
                    startInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
                    startInput.style.borderRadius = '6px';
                    startInput.style.color = '#fff';
                    startInput.style.fontSize = '14px';
                    
                    const endInput = document.createElement('input');
                    endInput.type = 'text';
                    endInput.value = window.end || '';
                    endInput.style.padding = '8px 12px';
                    endInput.style.background = 'rgba(55, 65, 81, 0.5)';
                    endInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
                    endInput.style.borderRadius = '6px';
                    endInput.style.color = '#fff';
                    endInput.style.fontSize = '14px';
                    
                    const multiplierInput = document.createElement('input');
                    multiplierInput.type = 'number';
                    multiplierInput.min = '0.1';
                    multiplierInput.max = '10';
                    multiplierInput.step = '0.1';
                    multiplierInput.value = window.multiplier || 1.5;
                    multiplierInput.style.padding = '8px 12px';
                    multiplierInput.style.background = 'rgba(55, 65, 81, 0.5)';
                    multiplierInput.style.border = '1px solid rgba(75, 85, 99, 0.5)';
                    multiplierInput.style.borderRadius = '6px';
                    multiplierInput.style.color = '#fff';
                    multiplierInput.style.fontSize = '14px';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '√ó';
                    deleteBtn.onclick = () => windowDiv.remove();
                    deleteBtn.style.padding = '8px 12px';
                    deleteBtn.style.background = '#ef4444';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.borderRadius = '6px';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.fontSize = '18px';
                    deleteBtn.style.fontWeight = 'bold';
                    
                    windowDiv.appendChild(startInput);
                    windowDiv.appendChild(endInput);
                    windowDiv.appendChild(multiplierInput);
                    windowDiv.appendChild(deleteBtn);
                    container.appendChild(windowDiv);
                });
            }
        }
    } catch (err) {
        console.error('Error loading grid tariffs config:', err);
    }
}

async function saveGridTariffsConfig() {
    const enabled = document.getElementById('grid-tariffs-enabled').checked;
    const structure = document.getElementById('grid-tariffs-structure').value;
    const timeVariable = document.getElementById('grid-tariffs-time-variable').checked;
    const baseTariff = parseFloat(document.getElementById('grid-tariffs-base-tariff').value) || 0.15;
    
    // Collect windows
    const windows = [];
    const container = document.getElementById('grid-tariffs-windows-container');
    container.querySelectorAll('div').forEach(windowDiv => {
        const inputs = windowDiv.querySelectorAll('input');
        if (inputs.length >= 3) {
            const start = inputs[0].value.trim();
            const end = inputs[1].value.trim();
            const multiplier = parseFloat(inputs[2].value) || 1.0;
            if (start && end) {
                windows.push({
                    start: start,
                    end: end,
                    multiplier: multiplier
                });
            }
        }
    });
    
    const config = {
        enabled: enabled,
        tariff_structure: structure,
        time_variable: timeVariable,
        base_tariff_eur_per_kw: baseTariff,
        high_load_windows: windows
    };
    
    // F√ºge site_id hinzu, wenn Multi-Site aktiv
    if (currentSiteId !== null) {
        config.site_id = currentSiteId;
    }
    
    try {
        const resp = await fetch('/api/config/grid_tariffs', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        
        // Check if response is OK
        if (!resp.ok) {
            const text = await resp.text();
            console.error('Server response:', text);
            alert('‚ùå Fehler beim Speichern: HTTP ' + resp.status + ' - ' + text);
            return;
        }
        
        // Try to parse JSON
        let data;
        const contentType = resp.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            data = await resp.json();
        } else {
            const text = await resp.text();
            console.error('Non-JSON response:', text);
            alert('‚ùå Fehler: Server antwortete nicht mit JSON. Antwort: ' + text.substring(0, 100));
            return;
        }
        
        if (data.success) {
            alert('‚úÖ Netzentgelte-Konfiguration gespeichert!');
        } else {
            alert('‚ùå Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (err) {
        console.error('Error saving grid tariffs config:', err);
        alert('‚ùå Fehler beim Speichern: ' + err.message);
    }
}

// Multi-Site Functions
let multiSiteEnabled = false;
let sitesList = [];

async function loadMultiSiteStatus() {
    try {
        const resp = await fetch('/api/sites');
        if (!resp.ok) {
            console.warn(`API returned ${resp.status}: ${resp.statusText}`);
            // Fallback: Setze Single-Site-Modus
            multiSiteEnabled = false;
            sitesList = [];
            const checkbox = document.getElementById('multisite-enabled');
            if (checkbox) {
                checkbox.checked = false;
                toggleMultiSiteConfig();
            }
            return;
        }
        
        const contentType = resp.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Response is not JSON:', contentType);
            const text = await resp.text();
            console.error('Response body:', text.substring(0, 200));
            return;
        }
        
        const data = await resp.json();
        multiSiteEnabled = data.multi_site || false;
        sitesList = data.sites || [];
        
        const checkbox = document.getElementById('multisite-enabled');
        if (checkbox) {
            checkbox.checked = multiSiteEnabled;
            toggleMultiSiteConfig(); // This will update the visual state
        }
        
        // Update Navigation Button visibility
        updateNavSitesVisibility(multiSiteEnabled);
        
        // Update sites count
        const countEl = document.getElementById('multisite-sites-count');
        if (countEl) {
            countEl.textContent = sitesList.length;
        }
        
        // Update sites list
        updateSitesList();
    } catch (err) {
        console.error('Error loading multi-site status:', err);
        // Fallback: Setze Single-Site-Modus
        multiSiteEnabled = false;
        sitesList = [];
        const checkbox = document.getElementById('multisite-enabled');
        if (checkbox) {
            checkbox.checked = false;
            toggleMultiSiteConfig();
        }
    }
}

function toggleMultiSiteConfig() {
    const checkbox = document.getElementById('multisite-enabled');
    if (!checkbox) return;
    
    const enabled = checkbox.checked;
    const config = document.getElementById('multisite-config');
    const warning = document.getElementById('multisite-warning');
    const slider = document.getElementById('multisite-toggle-slider');
    const knob = document.getElementById('multisite-toggle-knob');
    
    // Update toggle visual state
    if (enabled) {
        if (slider) {
            slider.style.backgroundColor = '#3b82f6';
            slider.style.borderColor = '#3b82f6';
            slider.style.boxShadow = 'inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 3px rgba(59, 130, 246, 0.3)';
        }
        if (knob) {
            knob.style.transform = 'translateX(28px)';
            knob.style.backgroundColor = '#ffffff';
        }
        if (config) {
            config.style.display = 'block';
            setTimeout(() => { if (config) config.style.opacity = '1'; }, 10);
        }
        if (warning) {
            warning.style.display = 'block';
        }
    } else {
        if (slider) {
            slider.style.backgroundColor = '#4b5563';
            slider.style.borderColor = 'rgba(75, 85, 99, 0.5)';
            slider.style.boxShadow = 'inset 0 2px 4px rgba(0,0,0,0.3)';
        }
        if (knob) {
            knob.style.transform = 'translateX(0)';
            knob.style.backgroundColor = '#ffffff';
        }
        if (config) {
            if (config.style.opacity !== '0') {
                config.style.opacity = '0';
            }
            setTimeout(() => { if (config) config.style.display = 'none'; }, 300);
        }
        if (warning) {
            warning.style.display = 'none';
        }
    }
}

async function handleMultiSiteToggle() {
    const checkbox = document.getElementById('multisite-enabled');
    if (!checkbox) return;
    
    const enabled = checkbox.checked;
    
    // Zeige UI sofort an/aus
    toggleMultiSiteConfig();
    
    // Update Navigation Button visibility
    updateNavSitesVisibility(enabled);
    
    // Speichere automatisch
    try {
        await saveMultiSiteConfig();
    } catch (err) {
        console.error('Error saving multi-site config:', err);
        // Reset checkbox bei Fehler
        checkbox.checked = !enabled;
        toggleMultiSiteConfig();
        updateNavSitesVisibility(!enabled);
    }
}

function updateNavSitesVisibility(enabled) {
    const navSites = document.getElementById('nav-sites');
    if (!navSites) return;
    
    if (enabled) {
        navSites.style.display = 'flex';
        navSites.href = '/sites';
        navSites.classList.remove('nav-link-disabled');
    } else {
        navSites.style.display = 'none';
        navSites.href = '#';
    }
}

function updateSitesList() {
    const container = document.getElementById('multisite-sites-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (sitesList.length === 0) {
        container.innerHTML = '<div style="padding: 16px; text-align: center; color: #94a3b8;">Keine Standorte konfiguriert</div>';
        return;
    }
    
    sitesList.forEach(site => {
        const siteDiv = document.createElement('div');
        siteDiv.style.padding = '12px';
        siteDiv.style.background = 'rgba(59, 130, 246, 0.1)';
        siteDiv.style.border = '1px solid rgba(59, 130, 246, 0.3)';
        siteDiv.style.borderRadius = '8px';
        siteDiv.style.marginBottom = '8px';
        siteDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">${site.name || `Site ${site.id}`}</div>
                    <div style="font-size: 12px; color: #94a3b8;">
                        ${site.location?.city || 'Keine Ortsangabe'} | 
                        BESS: ${site.config?.bess?.energy_capacity_kw || 'N/A'} kWh
                    </div>
                </div>
                <div style="color: #60a5fa; font-size: 12px;">
                    ID: ${site.id}
                </div>
            </div>
        `;
        container.appendChild(siteDiv);
    });
}

async function saveMultiSiteConfig() {
    const enabled = document.getElementById('multisite-enabled').checked;
    
    // Zeige kurze Best√§tigung ohne Dialog
    const statusMsg = document.createElement('div');
    statusMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 12px 20px; background: #3b82f6; color: white; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 14px; font-weight: 600;';
    statusMsg.textContent = enabled ? 'üîÑ Multi-Site wird aktiviert...' : 'üîÑ Multi-Site wird deaktiviert...';
    document.body.appendChild(statusMsg);
    
    try {
        const resp = await fetch('/api/config/multisite', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ enabled: enabled })
        });
        
        if (!resp.ok) {
            const errorText = await resp.text();
            console.error(`API returned ${resp.status}: ${errorText}`);
            throw new Error(`Server-Fehler: ${resp.status} ${resp.statusText}`);
        }
        
        const contentType = resp.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await resp.text();
            console.error('Response is not JSON:', contentType, text.substring(0, 200));
            throw new Error('Ung√ºltige Antwort vom Server');
        }
        
        const data = await resp.json();
        
        if (data.success) {
            statusMsg.style.background = '#10b981';
            statusMsg.textContent = `‚úÖ ${enabled ? 'Multi-Site aktiviert' : 'Multi-Site deaktiviert'}`;
            
            // Entferne Nachricht nach 2 Sekunden
            setTimeout(() => {
                statusMsg.style.opacity = '0';
                statusMsg.style.transition = 'opacity 0.3s';
                setTimeout(() => statusMsg.remove(), 300);
            }, 2000);
            
            // Lade Status neu
            await loadMultiSiteStatus();
        } else {
            console.error('Multi-Site config save failed:', data);
            statusMsg.style.background = '#ef4444';
            statusMsg.textContent = '‚ùå Fehler: ' + (data.error || 'Unbekannter Fehler');
            setTimeout(() => statusMsg.remove(), 4000);
            
            // Reset checkbox bei Fehler
            const checkbox = document.getElementById('multisite-enabled');
            if (checkbox) {
                checkbox.checked = !enabled;
                toggleMultiSiteConfig();
            }
        }
    } catch (err) {
        console.error('Error saving multi-site config:', err);
        statusMsg.style.background = '#ef4444';
        statusMsg.textContent = '‚ùå Fehler: ' + (err.message || 'Verbindungsfehler');
        setTimeout(() => statusMsg.remove(), 4000);
        
        // Reset checkbox bei Fehler
        const checkbox = document.getElementById('multisite-enabled');
        if (checkbox) {
            checkbox.checked = !enabled;
            toggleMultiSiteConfig();
        }
    }
}

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMultiSiteStatus();
    loadSites(); // Lade Standorte f√ºr Multi-Site-Auswahl
    loadFeedinConfig();
    loadGridConfig();
    loadGridTariffsConfig();
    loadAIStatus(); // Lade AI-Status
});
</script>

{% endblock %}
