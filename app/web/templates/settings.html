{% extends 'base.html' %}

{% block content %}
<!-- Header -->
<div style="margin-bottom: 24px;">
    <h1>Einstellungen</h1>
    <p class="subtitle">Konfiguration des EMS-Systems</p>
</div>

<!-- Settings Container -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- Strategien -->
    <div class="card">
        <h2>
            <svg class="text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
            </svg>
            Strategie-Steuerung
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                Modus
            </label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button id="btn-auto" onclick="setStrategyMode('auto')" 
                        style="padding: 12px 20px; background: #3b82f6; border: 2px solid #3b82f6; border-radius: 10px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>ü§ñ</span>
                    <span>Automatisch</span>
                </button>
                <button id="btn-manual" onclick="setStrategyMode('manual')" 
                        style="padding: 12px 20px; background: rgba(55, 65, 81, 0.5); border: 2px solid rgba(75, 85, 99, 0.5); border-radius: 10px; color: #cbd5e1; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>‚úã</span>
                    <span>Manuell</span>
                </button>
            </div>
        </div>
        
        <div id="strategy-selector" style="display: none; margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                Strategie w√§hlen
            </label>
            <select id="strategy-select" onchange="selectStrategy()" 
                    style="width: 100%; padding: 14px 16px; background: #0f172a; border: 2px solid #475569; border-radius: 10px; color: #fff; font-size: 15px; font-weight: 500; cursor: pointer;">
                <option value="arbitrage">üí∞ Arbitrage</option>
                <option value="peak_shaving">üìä Peak Shaving</option>
                <option value="self_consumption">‚òÄÔ∏è Self Consumption</option>
                <option value="load_balancing">‚öñÔ∏è Load Balancing</option>
            </select>
        </div>
        
        <div id="current-strategy" 
             style="padding: 16px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #93c5fd; font-size: 14px;">
            <strong>Aktuell:</strong> <span id="active-strategy-name">Lade...</span>
        </div>
    </div>
    
    <!-- BESS Parameter -->
    <div class="card">
        <h2>
            <svg class="text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm-2 4a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path>
            </svg>
            BESS Parameter
        </h2>
        
        <div style="color: #94a3b8; font-size: 14px; background: rgba(100, 116, 139, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            ‚ÑπÔ∏è Aktuelle Konfiguration aus <code style="color: #60a5fa;">config/ems.yaml</code>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Kapazit√§t</p>
                <p style="color: #fff; font-weight: 600;">200 kWh</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Max Ladeleistung</p>
                <p style="color: #fff; font-weight: 600;">100 kW</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Max Entladeleistung</p>
                <p style="color: #fff; font-weight: 600;">100 kW</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">SoC Min/Max</p>
                <p style="color: #fff; font-weight: 600;">10% / 90%</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Lade-Effizienz</p>
                <p style="color: #fff; font-weight: 600;">95%</p>
            </div>
            <div>
                <p style="color: #9ca3af; margin-bottom: 4px;">Entlade-Effizienz</p>
                <p style="color: #fff; font-weight: 600;">95%</p>
            </div>
        </div>
        
        <p style="margin-top: 16px; font-size: 13px; color: #64748b; text-align: center;">
            Zum √Ñndern: <code style="color: #60a5fa;">app/config/ems.yaml</code> bearbeiten
        </p>
    </div>
</div>

<!-- MQTT/Modbus Configuration Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    
    <!-- MQTT Configuration -->
    <div class="card">
        <h2>
            <svg class="text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
            MQTT Konfiguration
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                <input type="checkbox" id="mqtt-enabled" onchange="toggleMqttConfig()" style="width: 16px; height: 16px;">
                MQTT aktivieren
            </label>
        </div>
        
        <!-- MQTT Config - IMMER SICHTBAR f√ºr Test -->
        <div id="mqtt-config" style="display: block; opacity: 1;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Broker Host</label>
                    <input type="text" id="mqtt-host" value="localhost" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Port</label>
                    <input type="number" id="mqtt-port" value="1883" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Username</label>
                    <input type="text" id="mqtt-username" placeholder="Optional" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Password</label>
                    <input type="password" id="mqtt-password" placeholder="Optional" 
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Client ID</label>
                <input type="text" id="mqtt-client-id" value="phoenyra_ems" 
                       style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>
            
            <!-- MQTT Topics Configuration -->
            <div style="margin-bottom: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
                <h3 style="color: #60a5fa; font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    üì° MQTT Topics
                </h3>
                
                <!-- Publish Topics -->
                <div style="margin-bottom: 16px;">
                    <h4 style="color: #93c5fd; font-size: 14px; font-weight: 600; margin-bottom: 8px;">üì§ Publish Topics (EMS ‚Üí MQTT)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Status</label>
                            <input type="text" id="mqtt-topic-publish-status" value="ems/status" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Optimization</label>
                            <input type="text" id="mqtt-topic-publish-optimization" value="ems/optimization" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Alerts</label>
                            <input type="text" id="mqtt-topic-publish-alerts" value="ems/alerts" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">BESS Data</label>
                            <input type="text" id="mqtt-topic-publish-bess" value="bess/data" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                    </div>
                </div>
                
                <!-- Subscribe Topics -->
                <div style="margin-bottom: 16px;">
                    <h4 style="color: #93c5fd; font-size: 14px; font-weight: 600; margin-bottom: 8px;">üì• Subscribe Topics (MQTT ‚Üí EMS)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Commands</label>
                            <input type="text" id="mqtt-topic-subscribe-commands" value="ems/commands" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Setpoints</label>
                            <input type="text" id="mqtt-topic-subscribe-setpoints" value="ems/setpoints" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Strategy Override</label>
                            <input type="text" id="mqtt-topic-subscribe-strategy" value="ems/strategy_override" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Config Updates</label>
                            <input type="text" id="mqtt-topic-subscribe-config" value="ems/config" 
                                   style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 8px 12px; background: rgba(15, 23, 42, 0.6); border-radius: 6px;">
                    <p style="color: #94a3b8; font-size: 12px; margin: 0;">
                        üí° <strong>Hinweis:</strong> Topics werden automatisch mit dem Client ID als Pr√§fix versehen: <code>phoenyra_ems/</code>
                    </p>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button onclick="testMqttConnection()" 
                        style="flex: 1; padding: 10px 16px; background: #10b981; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üîó Test Verbindung
                </button>
                <button onclick="saveMqttConfig()" 
                        style="flex: 1; padding: 10px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üíæ Speichern
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modbus Configuration -->
    <div class="card">
        <h2>
            <svg class="text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
            Modbus Konfiguration
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #cbd5e1; margin-bottom: 12px;">
                <input type="checkbox" id="modbus-enabled" onchange="toggleModbusConfig()" style="width: 16px; height: 16px;">
                Modbus aktivieren
            </label>
        </div>
        
        <div id="modbus-config" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Verbindungstyp</label>
                <select id="modbus-type" onchange="toggleModbusType()" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    <option value="tcp">TCP/IP</option>
                    <option value="rtu">RTU (Serial)</option>
                </select>
            </div>
            
            <div id="modbus-tcp-config" style="opacity: 1; transition: opacity 0.3s ease;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Host</label>
                        <input type="text" id="modbus-host" value="localhost" 
                               style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Port</label>
                        <input type="number" id="modbus-port" value="502" 
                               style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Slave ID</label>
                    <input type="number" id="modbus-slave-id" value="1"
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Retries</label>
                    <input type="number" id="modbus-retries" value="3"
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Poll-Intervall (s)</label>
                    <input type="number" id="modbus-poll-interval" value="2"
                           style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px;">Vordefiniertes Profil</label>
                <select id="modbus-profile-select" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; color: #fff; font-size: 14px;">
                    <option value="">Benutzerdefiniert</option>
                </select>
                <div id="modbus-profile-meta" style="margin-top: 8px; font-size: 12px; color: #94a3b8;"></div>
            </div>
            
            <div style="margin-bottom: 20px; padding: 16px; background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.25); border-radius: 10px;">
                <h3 style="color: #fbbf24; font-size: 15px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    üß≠ Modbus Register Mapping
                </h3>
                <p style="color: #cbd5f5; font-size: 12px; margin-bottom: 12px;">
                    Die Register werden je nach Herstellerprofil vorbelegt. Du kannst Adressen bei Bedarf anpassen ‚Äì Skalierung, Einheit und Funktionscode stammen aus dem ausgew√§hlten Profil.
                </p>
                <div id="modbus-register-container" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button onclick="testModbusConnection()" 
                        style="flex: 1; padding: 10px 16px; background: #10b981; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üîó Test Verbindung
                </button>
                <button onclick="saveModbusConfig()" 
                        style="flex: 1; padding: 10px 16px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                    üíæ Speichern
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMode = 'auto';

const MODBUS_FUNCTION_NAMES = {
    2: 'Discrete Input (02)',
    3: 'Holding Register (03)',
    4: 'Input Register (04)'
};

const MODBUS_REGISTER_LABELS = {
    soc_percent: { label: 'SoC (%)', description: 'System State of Charge', category: 'telemetry' },
    soh_percent: { label: 'SOH (%)', description: 'System State of Health', category: 'telemetry' },
    voltage_v: { label: 'Spannung (V)', description: 'System-Gesamtspannung', category: 'telemetry' },
    current_a: { label: 'Strom (A)', description: 'Systemstrom (positiv = Laden)', category: 'telemetry' },
    temperature_c: { label: 'Temperatur (degC)', description: 'Durchschnittliche Systemtemperatur', category: 'telemetry' },
    max_discharge_power_kw: { label: 'Max. Entladeleistung (kW)', category: 'limit' },
    max_charge_power_kw: { label: 'Max. Ladeleistung (kW)', category: 'limit' },
    max_discharge_current_a: { label: 'Max. Entladestrom (A)', category: 'limit' },
    max_charge_current_a: { label: 'Max. Ladestrom (A)', category: 'limit' },
    insulation_resistance_kohm: { label: 'Isolationswiderstand (kOhm)', category: 'diagnostics' },
    status_code: { label: 'Statuscode', description: 'BMS Systemstatus', category: 'status' },
    pcs_comm_fault: { label: 'PCS <-> BMS Kommunikation', category: 'diagnostics' },
    ems_comm_fault: { label: 'EMS <-> BMS Kommunikation', category: 'diagnostics' }
};

const MODBUS_REGISTER_ORDER = [
    'soc_percent',
    'soh_percent',
    'voltage_v',
    'current_a',
    'temperature_c',
    'max_discharge_power_kw',
    'max_charge_power_kw',
    'max_discharge_current_a',
    'max_charge_current_a',
    'insulation_resistance_kohm',
    'status_code',
    'pcs_comm_fault',
    'ems_comm_fault'
];

let modbusSelectedProfile = '';
let modbusRegisterDefinitions = {};
let modbusProfileSummaries = {};
let modbusProfileDetailsCache = {};
let modbusStatusCodes = {};

function mergeRegisterDefinitions(base, overrides) {
    const result = {};
    const keys = new Set([
        ...Object.keys(base || {}),
        ...Object.keys(overrides || {})
    ]);
    keys.forEach(key => {
        const baseDef = base && base[key] ? { ...base[key] } : {};
        const overrideDef = overrides && overrides[key] ? { ...overrides[key] } : {};
        result[key] = { ...baseDef, ...overrideDef };
    });
    return result;
}

function formatModbusMeta(definition) {
    const fn = MODBUS_FUNCTION_NAMES[definition.function] || `Function ${definition.function || 3}`;
    const scale = definition.scale !== undefined ? definition.scale : 1;
    const offset = definition.offset !== undefined ? definition.offset : 0;
    const unit = definition.unit ? `Einheit ${definition.unit}` : 'Einheit -';
    const category = definition.category ? `Kategorie ${definition.category}` : '';
    return [fn, `Skalierung ${scale}`, `Offset ${offset}`, unit, category].filter(Boolean).join(' | ');
}

function buildModbusProfileOptions(summaries, selected) {
    const select = document.getElementById('modbus-profile-select');
    if (!select) return;
    select.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Benutzerdefiniert';
    select.appendChild(defaultOption);
    Object.entries(summaries || {}).forEach(([key, meta]) => {
        const option = document.createElement('option');
        option.value = key;
        const labelParts = [];
        if (meta.label) labelParts.push(meta.label);
        if (meta.manufacturer) labelParts.push(meta.manufacturer);
        option.textContent = labelParts.length ? labelParts.join(' | ') : key;
        if (key === selected) {
            option.selected = true;
        }
        select.appendChild(option);
    });
    if (!selected) {
        select.value = '';
    }
}

function updateModbusProfileMeta(profile) {
    const metaEl = document.getElementById('modbus-profile-meta');
    if (!metaEl) return;
    if (!profile) {
        metaEl.textContent = 'Kein Profil ausgew√§hlt. Alle Register k√∂nnen manuell gepflegt werden.';
        return;
    }
    const parts = [];
    if (profile.label) parts.push(profile.label);
    if (profile.manufacturer) parts.push(`Hersteller: ${profile.manufacturer}`);
    if (profile.documentation) parts.push(`Dokumentation: ${profile.documentation}`);
    metaEl.textContent = parts.join(' | ');
}

function buildModbusRegisterTable() {
    const container = document.getElementById('modbus-register-container');
    if (!container) return;
    container.innerHTML = '';

    const definitions = modbusRegisterDefinitions || {};
    if (Object.keys(definitions).length === 0) {
        const empty = document.createElement('div');
        empty.style.color = '#94a3b8';
        empty.style.fontSize = '12px';
        empty.textContent = 'Keine Register definiert. W√§hle ein Profil oder trage manuell Werte ein.';
        container.appendChild(empty);
        return;
    }

    const keys = Array.from(new Set([...MODBUS_REGISTER_ORDER, ...Object.keys(definitions)]));
    keys.forEach(key => {
        const definition = definitions[key];
        if (!definition) return;

        const labels = MODBUS_REGISTER_LABELS[key] || { label: key };
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '16px';
        row.style.alignItems = 'flex-start';
        row.style.background = 'rgba(15, 23, 42, 0.45)';
        row.style.border = '1px solid rgba(148, 163, 184, 0.35)';
        row.style.borderRadius = '10px';
        row.style.padding = '12px 14px';
        row.style.backdropFilter = 'blur(4px)';

        const metaCol = document.createElement('div');
        metaCol.style.flex = '1';

        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.style.color = '#e2e8f0';
        title.textContent = labels.label || key;

        const desc = document.createElement('div');
        desc.style.fontSize = '12px';
        desc.style.color = '#94a3b8';
        desc.textContent = definition.description || labels.description || '';

        const meta = document.createElement('div');
        meta.style.fontSize = '11px';
        meta.style.color = '#60a5fa';
        meta.textContent = formatModbusMeta(definition);

        metaCol.appendChild(title);
        if (desc.textContent) {
            metaCol.appendChild(desc);
        }
        metaCol.appendChild(meta);

        const inputCol = document.createElement('div');
        inputCol.style.width = '140px';

        const label = document.createElement('label');
        label.style.display = 'block';
        label.style.fontSize = '11px';
        label.style.fontWeight = '600';
        label.style.color = '#94a3b8';
        label.style.marginBottom = '4px';
        label.textContent = 'Adresse';

        const input = document.createElement('input');
        input.type = 'number';
        input.id = `modbus-register-${key}`;
        input.dataset.registerKey = key;
        input.value = definition.address !== undefined ? definition.address : '';
        input.style.width = '100%';
        input.style.padding = '8px 10px';
        input.style.background = 'rgba(55, 65, 81, 0.5)';
        input.style.border = '1px solid rgba(75, 85, 99, 0.5)';
        input.style.borderRadius = '6px';
        input.style.color = '#ffffff';

        inputCol.appendChild(label);
        inputCol.appendChild(input);

        row.appendChild(metaCol);
        row.appendChild(inputCol);

        container.appendChild(row);
    });
}

async function handleModbusProfileChange() {
    const select = document.getElementById('modbus-profile-select');
    if (!select) return;

    modbusSelectedProfile = select.value;
    let profileDetails = null;

    if (modbusSelectedProfile) {
        if (!modbusProfileDetailsCache[modbusSelectedProfile]) {
            try {
                const resp = await fetch(`/api/modbus/profiles?profile=${encodeURIComponent(modbusSelectedProfile)}`);
                const data = await resp.json();
                if (data.success) {
                    modbusProfileDetailsCache[modbusSelectedProfile] = data.profile;
                } else {
                    alert('‚ùå Profil konnte nicht geladen werden: ' + (data.error || 'Unbekannter Fehler'));
                    modbusProfileDetailsCache[modbusSelectedProfile] = null;
                }
            } catch (err) {
                alert('‚ùå Profil konnte nicht geladen werden: ' + err.message);
                modbusProfileDetailsCache[modbusSelectedProfile] = null;
            }
        }
        profileDetails = modbusProfileDetailsCache[modbusSelectedProfile];
    }

    const baseRegisters = profileDetails && profileDetails.registers ? profileDetails.registers : {};
    modbusStatusCodes = profileDetails && profileDetails.status_codes ? profileDetails.status_codes : {};
    modbusRegisterDefinitions = mergeRegisterDefinitions(baseRegisters, {});
    updateModbusProfileMeta(profileDetails);
    buildModbusRegisterTable();
}

async function loadSettings() {
    try {
        const resp = await fetch('/api/strategies');
        const data = await resp.json();
        
        currentMode = data.mode || 'auto';
        document.getElementById('active-strategy-name').textContent = 
            data.current || 'Keine Strategie aktiv';
        
        if (currentMode === 'manual') {
            document.getElementById('btn-manual').classList.add('active');
            document.getElementById('btn-auto').classList.remove('active');
            document.getElementById('strategy-selector').style.display = 'block';
            
            if (data.current) {
                document.getElementById('strategy-select').value = data.current;
            }
        }
    } catch (err) {
        console.error('Error loading settings:', err);
    }
}

async function setStrategyMode(mode) {
    currentMode = mode;
    
    const btnAuto = document.getElementById('btn-auto');
    const btnManual = document.getElementById('btn-manual');
    
    if (mode === 'auto') {
        btnAuto.style.background = '#3b82f6';
        btnAuto.style.borderColor = '#3b82f6';
        btnAuto.style.color = 'white';
        
        btnManual.style.background = 'rgba(55, 65, 81, 0.5)';
        btnManual.style.borderColor = 'rgba(75, 85, 99, 0.5)';
        btnManual.style.color = '#cbd5e1';
        
        document.getElementById('strategy-selector').style.display = 'none';
        
        try {
            const resp = await fetch('/api/strategy/auto', { method: 'POST' });
            const data = await resp.json();
            
            if (data.success) {
                alert('‚úÖ Automatischer Modus aktiviert!');
                setTimeout(loadSettings, 1000);
            }
        } catch (err) {
            alert('‚ùå Fehler: ' + err.message);
        }
        
    } else {
        btnManual.style.background = '#3b82f6';
        btnManual.style.borderColor = '#3b82f6';
        btnManual.style.color = 'white';
        
        btnAuto.style.background = 'rgba(55, 65, 81, 0.5)';
        btnAuto.style.borderColor = 'rgba(75, 85, 99, 0.5)';
        btnAuto.style.color = '#cbd5e1';
        
        document.getElementById('strategy-selector').style.display = 'block';
    }
}

async function selectStrategy() {
    const strategy = document.getElementById('strategy-select').value;
    
    try {
        const resp = await fetch('/api/strategy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ strategy: strategy })
        });
        
        const data = await resp.json();
        
        if (data.success) {
            alert('‚úÖ Strategie gewechselt zu: ' + strategy);
            document.getElementById('active-strategy-name').textContent = strategy;
        } else {
            alert('‚ùå Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (err) {
        alert('‚ùå Fehler: ' + err.message);
    }
}

function toggleMqttConfig() {
    const enabled = document.getElementById('mqtt-enabled').checked;
    const config = document.getElementById('mqtt-config');
    
    if (config) {
        if (enabled) {
            config.style.display = 'block';
            config.style.opacity = '1';
        } else {
            config.style.opacity = '0';
            setTimeout(() => {
                config.style.display = 'none';
            }, 300);
        }
    }
}

function saveMqttConfig() {
    const config = {
        enabled: document.getElementById('mqtt-enabled').checked,
        broker_host: document.getElementById('mqtt-host').value,
        broker_port: parseInt(document.getElementById('mqtt-port').value, 10),
        username: document.getElementById('mqtt-username').value || null,
        password: document.getElementById('mqtt-password').value || null,
        client_id: document.getElementById('mqtt-client-id').value,
        topics: {
            publish: {
                status: document.getElementById('mqtt-topic-publish-status').value,
                optimization: document.getElementById('mqtt-topic-publish-optimization').value,
                alerts: document.getElementById('mqtt-topic-publish-alerts').value,
                bess: document.getElementById('mqtt-topic-publish-bess').value
            },
            subscribe: {
                commands: document.getElementById('mqtt-topic-subscribe-commands').value,
                setpoints: document.getElementById('mqtt-topic-subscribe-setpoints').value,
                strategy: document.getElementById('mqtt-topic-subscribe-strategy').value,
                config: document.getElementById('mqtt-topic-subscribe-config').value
            }
        }
    };
    
    fetch('/api/mqtt/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ MQTT Konfiguration gespeichert!');
        } else {
            alert('‚ùå Fehler beim Speichern: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Fehler beim Speichern der MQTT Konfiguration: ' + error.message);
    });
}

function testMqttConnection() {
    alert('üîó MQTT Verbindungstest (Demo)');
}

function toggleModbusConfig() {
    const enabled = document.getElementById('modbus-enabled').checked;
    const config = document.getElementById('modbus-config');
    
    if (enabled) {
        config.style.display = 'block';
        config.offsetHeight;
        config.style.opacity = '1';
    } else {
        config.style.opacity = '0';
        setTimeout(() => {
            config.style.display = 'none';
        }, 300);
    }
}

function toggleModbusType() {
    const type = document.getElementById('modbus-type').value;
    const tcpConfig = document.getElementById('modbus-tcp-config');
    const rtuConfig = document.getElementById('modbus-rtu-config');
    
    if (type === 'tcp') {
        if (rtuConfig) rtuConfig.style.display = 'none';
        tcpConfig.style.display = 'block';
        tcpConfig.offsetHeight;
        tcpConfig.style.opacity = '1';
    } else {
        tcpConfig.style.display = 'none';
        if (rtuConfig) {
            rtuConfig.style.display = 'block';
            rtuConfig.offsetHeight;
            rtuConfig.style.opacity = '1';
        }
    }
}

function collectModbusConfigInput() {
    const type = document.getElementById('modbus-type').value;
    const config = {
        enabled: document.getElementById('modbus-enabled').checked,
        connection_type: type,
        slave_id: parseInt(document.getElementById('modbus-slave-id').value, 10) || 1,
        retries: parseInt(document.getElementById('modbus-retries').value, 10) || 3,
        poll_interval_s: parseFloat(document.getElementById('modbus-poll-interval').value) || 2.0,
        profile: modbusSelectedProfile || null,
        timeout: 3.0
    };

    const statusPrepared = {};
    Object.keys(modbusStatusCodes || {}).forEach(key => {
        statusPrepared[String(key)] = modbusStatusCodes[key];
    });
    if (Object.keys(statusPrepared).length > 0) {
        config.status_codes = statusPrepared;
    }
    
    if (type === 'tcp') {
        config.host = document.getElementById('modbus-host').value || 'localhost';
        config.port = parseInt(document.getElementById('modbus-port').value, 10) || 502;
    }
    
    const registers = {};
    Object.keys(modbusRegisterDefinitions || {}).forEach(key => {
        const input = document.getElementById(`modbus-register-${key}`);
        const definition = { ...modbusRegisterDefinitions[key] };
        if (input && input.value !== '') {
            const val = parseInt(input.value, 10);
            if (!Number.isNaN(val)) {
                definition.address = val;
            } else {
                delete definition.address;
            }
        }
        registers[key] = definition;
        modbusRegisterDefinitions[key] = definition;
    });
    config.registers = registers;
    
    return config;
}

async function testModbusConnection() {
    const config = collectModbusConfigInput();
    try {
        const resp = await fetch('/api/modbus/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (data.success) {
            alert('‚úÖ Modbus Verbindung erfolgreich getestet!');
        } else {
            alert('‚ùå Modbus Test fehlgeschlagen: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (error) {
        alert('‚ùå Modbus Test fehlgeschlagen: ' + error.message);
    }
}

async function saveModbusConfig() {
    const config = collectModbusConfigInput();
    try {
        const resp = await fetch('/api/modbus/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (data.success) {
            alert('‚úÖ Modbus Konfiguration gespeichert!');
        } else {
            alert('‚ùå Fehler beim Speichern: ' + (data.error || 'Unbekannter Fehler'));
        }
    } catch (error) {
        alert('‚ùå Fehler beim Speichern der Modbus Konfiguration: ' + error.message);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const profileSelect = document.getElementById('modbus-profile-select');
    if (profileSelect) {
        profileSelect.addEventListener('change', () => {
            handleModbusProfileChange();
        });
    }

    fetch('/api/mqtt/config')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            document.getElementById('mqtt-enabled').checked = config.enabled || false;
            document.getElementById('mqtt-host').value = config.broker_host || 'localhost';
            document.getElementById('mqtt-port').value = config.broker_port || 1883;
            document.getElementById('mqtt-username').value = config.username || '';
            document.getElementById('mqtt-password').value = config.password || '';
            document.getElementById('mqtt-client-id').value = config.client_id || 'phoenyra_ems';
            
            if (config.topics) {
                if (config.topics.publish) {
                    document.getElementById('mqtt-topic-publish-status').value = config.topics.publish.status || 'ems/status';
                    document.getElementById('mqtt-topic-publish-optimization').value = config.topics.publish.optimization || 'ems/optimization';
                    document.getElementById('mqtt-topic-publish-alerts').value = config.topics.publish.alerts || 'ems/alerts';
                    document.getElementById('mqtt-topic-publish-bess').value = config.topics.publish.bess || 'bess/data';
                }
                if (config.topics.subscribe) {
                    document.getElementById('mqtt-topic-subscribe-commands').value = config.topics.subscribe.commands || 'ems/commands';
                    document.getElementById('mqtt-topic-subscribe-setpoints').value = config.topics.subscribe.setpoints || 'ems/setpoints';
                    document.getElementById('mqtt-topic-subscribe-strategy').value = config.topics.subscribe.strategy || 'ems/strategy_override';
                    document.getElementById('mqtt-topic-subscribe-config').value = config.topics.subscribe.config || 'ems/config';
                }
            }
        }
    })
    .catch(error => {
        console.error('Error loading MQTT config:', error);
    });
    
    fetch('/api/modbus/config')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            modbusProfileSummaries = data.profiles || {};
            const profileDetails = data.profile || null;
            if (config.profile && profileDetails) {
                modbusProfileDetailsCache[config.profile] = profileDetails;
            }
            modbusSelectedProfile = config.profile || '';
            modbusStatusCodes = config.status_codes || {};
            const baseRegisters = profileDetails && profileDetails.registers ? profileDetails.registers : {};
            const userRegisters = config.registers || {};
            modbusRegisterDefinitions = mergeRegisterDefinitions(baseRegisters, userRegisters);
            
            document.getElementById('modbus-enabled').checked = config.enabled || false;
            document.getElementById('modbus-type').value = config.connection_type || 'tcp';
            document.getElementById('modbus-host').value = config.host || 'localhost';
            document.getElementById('modbus-port').value = config.port || 502;
            document.getElementById('modbus-slave-id').value = config.slave_id != null ? config.slave_id : 1;
            document.getElementById('modbus-retries').value = config.retries != null ? config.retries : 3;
            document.getElementById('modbus-poll-interval').value = config.poll_interval_s != null ? config.poll_interval_s : 2;
            
            buildModbusProfileOptions(modbusProfileSummaries, modbusSelectedProfile);
            updateModbusProfileMeta(profileDetails);
            buildModbusRegisterTable();
            
            toggleModbusConfig();
            toggleModbusType();
        }
    })
    .catch(error => {
        console.error('Error loading Modbus config:', error);
    });
    
    loadSettings();
});
</script>

{% endblock %}
